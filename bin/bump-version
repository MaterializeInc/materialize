#!/usr/bin/env bash

# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.
#
# bump-version â€” sets the Materialize version in appropriate files.

set -euo pipefail

cd "$(dirname "$0")/.."

. misc/shlib/shlib.bash

if [[ $# -lt 1 ]]; then
    die "usage: $0 VERSION [--no-commit] [--no-console-bump] [--sbom]"
fi

commit=true
console_bump=true
sbom=false

version=${1#v}
shift

while [[ $# -gt 0 ]]; do
    if [[ "$1" == "--no-commit" ]]; then
        commit=false
        shift
    elif [[ "$1" == "--no-console-bump" ]]; then
        console_bump=false
        shift
    elif [[ "$1" == "--sbom" ]]; then
        sbom=true
        shift
    else
        die "invalid flag: $2, only --no-commit, --no-console-bump and --sbom are supported"
    fi
done

if ! run git diff HEAD --compact-summary --exit-code; then
    die "cannot begin bump with uncommitted content"
fi

if $console_bump; then
    console_dir=console
    if is_truthy "${CI:-0}"; then
        GIT_TERMINAL_PROMPT=0 git clone "https://materializebot:$GITHUB_TOKEN@github.com/MaterializeInc/console" $console_dir
    else
        GIT_TERMINAL_PROMPT=0 git clone git@github.com:MaterializeInc/console $console_dir
    fi
    echo "Bumping console version to $version"
    (
        cd "$console_dir"
        git tag -a "$version" -m "$version"
        git push origin "$version"
    )

    echo "Waiting for console version to be released on DockerHub (~15 min)"
    console_version="${version#v}"
    console_image="materialize/console:$console_version"
    sleep $((15 * 60))
    while true; do
        if docker manifest inspect "$console_image" >/dev/null 2>&1; then
            break
        fi
        echo "$console_image not yet on DockerHub, sleeping 1 min"
        sleep 60
    done
    echo "$console_image found on DockerHub"
    sed -i.bak \
        "s/FROM materialize/console:.* AS console/FROM $console_image AS console/" \
        misc/images/materialized-base/Dockerfile
    sed -i.bak \
        "s/\"--console-image-tag-default=[^\"]*\"/\"--console-image-tag-default=$console_version\"/" \
        misc/helm-charts/operator/templates/deployment.yaml
fi

sed -i.bak \
    "s/^version = .*/version = \"$version\"/" \
    src/{clusterd,environmentd,materialized,persist-client,testdrive,catalog-debug,balancerd,orchestratord}/Cargo.toml

if ! [[ "$version" = *-dev* ]]; then
    sed -i.bak \
        "s/^Licensed Work:.*/Licensed Work:             Materialize Version v$version/" \
        LICENSE
else
    # Rename all upgrade tests that reference `current_source` to explicitly
    # reference the version of the last release.
    IFS='.' read -r -a parts <<< "$version"
    ((parts[1]--))
    last_version="${parts[0]}.${parts[1]}.0"
    for file in test/legacy-upgrade/*current_source*; do
        if [[ "$file" = *example* ]]; then
            continue
        fi
        git mv "$file" "$(echo "$file" | sed "s/current_source/v$last_version/")"
    done
fi

rm -f src/{clusterd,environmentd,materialized,persist-client,testdrive,catalog-debug,balancerd,orchestratord}/Cargo.toml.bak LICENSE.bak

cargo update --workspace

crd_descriptions_json=doc/user/data/self_managed/materialize_crd_descriptions.json
cargo run -p mz-cloud-resources --bin crd-writer > "${crd_descriptions_json}"
git add "${crd_descriptions_json}"

bin/helm-chart-version-bump --bump-orchestratord-version "v$version"

helm_docs_version=1.14.2
if ! helm-docs --help > /dev/null; then
    echo "helm-docs is currently not installed"
    echo "Install helm-docs $helm_docs_version from https://github.com/norwoodj/helm-docs/releases/tag/v$helm_docs_version"
    echo "Or use bin/ci-builder run stable ..."
    exit 1
fi
if [ "$(helm-docs --version)" != "helm-docs version $helm_docs_version" ]; then
    echo "helm-docs is installed, but has wrong version: $(helm-docs --version)"
    echo "Install helm-docs $helm_docs_version from https://github.com/norwoodj/helm-docs/releases/tag/v$helm_docs_version"
    exit 1
fi
# update README.md
helm-docs misc/helm-charts
# update values yaml descriptions
helm-docs misc/helm-charts -t misc/helm-charts/operator/value_descriptions.yml.gotmpl -o value_descriptions.yml
mv misc/helm-charts/operator/value_descriptions.yml doc/user/data/self_managed/materialize_operator_chart_parameter.yml

if $sbom; then
    if ! inspector-sbomgen --version > /dev/null; then
        echo "inspector-sbomgen is not installed, install from https://docs.aws.amazon.com/inspector/latest/user/sbom-generator.html"
        echo "Or use bin/ci-builder run stable ..."
        exit 1
    fi
    inspector_sbomgen_version=1.8.2
    if [ "$(inspector-sbomgen --version)" != "$inspector_sbomgen_version" ]; then
        echo "inspector-sbomgen is installed, but has wrong version: $(inspector-sbomgen --version)"
        echo "Install inspector-sbomgen $inspector_sbomgen_version from from https://docs.aws.amazon.com/inspector/latest/user/sbom-generator.html"
        exit 1
    fi
    rm -rf sbom
    mkdir sbom
    find . -type f -name "Dockerfile" -exec sed -i 's/MZFROM/FROM/g' {} +
    mkdir -p ~/.inspector-sbomgen
    inspector-sbomgen directory --path . --skip-files test --outfile "sbom/materialize.$version.cdx.json" --disable-progress-bar
    git ls-files | grep 'Dockerfile$' | xargs git checkout --
    git add sbom
fi

if $commit; then
    git commit -am "release: bump to version v$version"
fi
