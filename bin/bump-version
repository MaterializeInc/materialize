#!/usr/bin/env bash

# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.
#
# bump-version â€” sets the Materialize version in appropriate files.

set -euo pipefail

cd "$(dirname "$0")/.."

. misc/shlib/shlib.bash

if [[ $# -ne 1 ]]; then
    die "usage: $0 VERSION"
fi

version=${1#v}

sed -i.bak \
    "s/^version = .*/version = \"$version\"/" \
    src/{compute,environmentd,storaged}/Cargo.toml

if ! [[ "$version" = *dev || "$version" = *post ]]; then
    sed -i.bak \
        "s/^Licensed Work:.*/Licensed Work:             Materialize Version v$version/" \
        LICENSE
fi

rm -f src/{compute,environmentd,storaged}/Cargo.toml.bak LICENSE.bak

cargo check

git commit -am "release: bump to version v$version"
