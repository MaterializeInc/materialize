#!/usr/bin/env bash

# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.
#
# clear-corrupted-cargo-target-dir - Remove cargo target dir if internal
# compiler error is detected, necessary in CI as a workaround until
# https://github.com/rust-lang/rust/issues/148581 is solved.

set -euo pipefail

cd "$(dirname "$0")/.."

if ! grep -q "panicked at compiler/rustc_metadata/src/rmeta/def_path_hash_map.rs" "$1"; then
  exit
fi

echo "--- Detected Rust ICE (https://github.com/rust-lang/rust/issues/148581), clearing cargo target directories"
rm -rf target target-xcompile || true
exit 199
