#!/usr/bin/env bash

# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.
#
# cloud-push – build cloud Docker images and push to personal Docker Hub.

set -euo pipefail

cd "$(dirname "$0")/.."

. misc/shlib/shlib.bash

usage() {
    die "usage: $0 -u USERNAME -m BUILD-METADATA [-i IMAGE...] [-- mzimage args]"
}

if [[ $# -lt 4 ]]; then
    usage
fi


images=()
passthrough_args=""
while [ "$#" -gt 0 ]; do
    case "$1" in
      "-u"|"--username")
          username="$2"
          shift
      ;;
      "-m"|"--build-metadata")
          build_meta="$2"
          shift
      ;;
      "-i"|"--image")
          images+=("$2")
          shift;
          ;;
      "--")
          shift
          passthrough_args="$*"
          break # everything after -- is passed through
          ;;
    esac
    shift
done

if (( ${#images[@]} == 0 )); then
  images=( "environmentd" "clusterd" )
fi

# This script indiscriminately pushes to DockerHub, so it can't use GHCR images as the targets.
export MZ_GHCR=0

version=$(bin/pyactivate -c "from materialize.mz_version import MzVersion; print(MzVersion.parse_cargo())")
tag="$version--local.$build_meta"

for image in "${images[@]}"; do
    # shellcheck disable=SC2086
    passthrough_args/mzimage acquire --arch=aarch64 "$image" $passthrough_args
    # shellcheck disable=SC2086
    passthrough_argstag "$(bin/mzimage spec --arch=aarch64 "$image" $passthrough_args)" "$username/$image:$tag"
    docker push "$username/$image:$tag"
done

echo "Deploy this build to staging by running:"
echo
echo "    $ bin/mz profile init --endpoint=https://staging.console.materialize.com --profile=staging"
echo "    $ bin/mz region enable --version $username:$tag --region=aws/us-east-1 --profile=staging"
echo
