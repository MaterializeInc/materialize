#!/usr/bin/env bash

# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.
#
# gen-claude-skill -- Generate a Claude Code skill bundle from the documentation.
#
# Usage:
#   bin/gen-claude-skill [OUTPUT_DIR]
#
# Arguments:
#   OUTPUT_DIR  Directory to output the skill files (default: .claude/skills/materialize-docs)
#
# Examples:
#   bin/gen-claude-skill                           # Generate to default location
#   bin/gen-claude-skill /path/to/output           # Generate to custom location

set -euo pipefail

cd "$(dirname "$0")/.."

OUTPUT_DIR="${1:-.claude/skills/materialize-docs}"

# Ensure output directory exists
mkdir -p "$OUTPUT_DIR"

echo "Generating Claude skill from documentation..."
echo "Output directory: $OUTPUT_DIR"

# Build documentation with skill output format
cd doc/user
hugo --config config.toml,config.skill.toml \
     --destination "../../$OUTPUT_DIR" \
     --gc \
     --quiet

cd ../..

# Rename the home page to SKILL.md (Claude skill convention)
if [[ -f "$OUTPUT_DIR/index.md" ]]; then
    mv "$OUTPUT_DIR/index.md" "$OUTPUT_DIR/SKILL.md"
fi

# Clean up files not needed for the skill
rm -f "$OUTPUT_DIR/sitemap.xml" 2>/dev/null
rm -rf "$OUTPUT_DIR/images" 2>/dev/null
rm -f "$OUTPUT_DIR/materialize-openapi.yml" 2>/dev/null
rm -rf "$OUTPUT_DIR/releases" 2>/dev/null
rm -rf "$OUTPUT_DIR/self-managed" 2>/dev/null
rm -rf "$OUTPUT_DIR/stylesheet" 2>/dev/null
rm -rf "$OUTPUT_DIR/about" 2>/dev/null
rm -rf "$OUTPUT_DIR/get-started" 2>/dev/null

# Count generated files
FILE_COUNT=$(find "$OUTPUT_DIR" -name "*.md" | wc -l | tr -d ' ')

echo "Done! Generated $FILE_COUNT markdown files."
echo "Skill entry point: $OUTPUT_DIR/SKILL.md"
