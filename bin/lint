#!/usr/bin/env bash

# Copyright 2019 Materialize, Inc. All rights reserved.
#
# This file is part of Materialize. Materialize may not be used or
# distributed without the express permission of Materialize, Inc.
#
# lint â€” complains about misformatted files.

set -euo pipefail

cd "$(dirname "$0")/.."

failed=false

try() {
    if ! "$@"; then
        failed=true
    fi
}

# This Git incantation lists the source files in this repository. If you change
# it, please preserve the following properties:
#
#     1. files matched by a gitignore rule are excluded, and
#     2. deleted but unstaged files are excluded.
#
empty_tree=$(git hash-object -t tree /dev/null)
files=$(git diff --ignore-submodules=all --name-only "$empty_tree")

copyright_files=$(grep -vE \
    -e '.gitignore' \
    -e '.gitmodules' \
    -e '(^|/)Cargo\.lock$' \
    -e '(^|/)Cargo\.toml$' \
    -e '^LICENSE$' \
    -e '^rust-toolchain$' \
    -e '^rustfmt.toml$' \
    -e '\.md$' \
    -e '\.json$' \
    -e '^misc/docker/ci-builder/(rust.asc|ssh_known_hosts)$' \
    -e '^.github/' \
    <<< "$files"
)

try xargs -n1 awk -f misc/lint/copyright.awk <<< "$copyright_files"
try xargs -n1 misc/lint/trailing-newline.sh <<< "$files"

if $failed; then
    exit 1
fi
