#!/usr/bin/env bash

# Copyright 2019-2020 Materialize Materialize, Inc. All rights reserved.
#
# This file is part of Materialize. Materialize may not be used or
# distributed without the express permission of Materialize, Inc.
#
# san â€” enables an LLVM sanitizer for any wrapped cargo(1) commands.
#
# Example usages:
#
#     $ bin/san address cargo run --bin sqllogictest
#
#     $ bin/san address ci/test/slt-fast.sh
#
# Requires x64 and a nightly toolchain.

set -euo pipefail

cd "$(dirname "$0")/.."

. misc/shlib/shlib.bash

if [[ $# -lt 2 ]]; then
    die "usage: $0 <address|memory|thread|...> <command> [<arg>...]"
fi

MZ_DEV_SANITIZER=$1; shift
CARGO=$(command -v cargo)
PATH=$(pwd)/misc/sanshim:$PATH

export MZ_DEV_SANITIZER CARGO PATH

exec "$@"
