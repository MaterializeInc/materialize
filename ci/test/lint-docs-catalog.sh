#!/usr/bin/env bash

# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.
#
# Compare dependencies and their flags against a ground truth. This serves against accidentally enabling dependencies
# or feature flags.
#
# Example usages:
#
#     $ ci/test/lint-docs-catalog.sh
#
# To rewrite the stored files, pass the --rewrite option.

set -euo pipefail

catalog_files=(
  doc/user/content/sql/system-catalog/mz_internal.md
  doc/user/content/sql/system-catalog/mz_catalog.md
)

slt_directory=test/sqllogictest/autogenerated

rewrite=false

if [[ "${1:-}" = --rewrite ]]; then
    shift
    rewrite=true
fi

echo "Linting catalog docs, run with --rewrite to update .slt files"

function generate_slt() {
  bin/pyactivate ci/test/lint-docs-catalog.py "$@"
}

for catalog_file in "${catalog_files[@]}"; do
    slt="$slt_directory/$(basename "$catalog_file" .md).slt"
    if $rewrite; then
        generate_slt "$catalog_file" > "$slt"
    else
        diff --unified=0 "$slt" <(generate_slt "$catalog_file")
    fi
done
