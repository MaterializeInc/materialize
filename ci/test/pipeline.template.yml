# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

# This file is processed by mkpipeline.py to trim unnecessary steps in PR
# builds. The inputs for steps using the `mzcompose` plugin are computed
# automatically. Inputs for other steps need to be manually listed in the
# `inputs` key.

dag: true

steps:
  - id: build-x86_64
    label: ":docker: build x86_64"
    command: bin/ci-builder run stable bin/pyactivate --dev -m ci.test.build x86_64
    inputs:
      - "*"
    timeout_in_minutes: 60
    agents:
      queue: builder

  - id: lint-fast
    label: ":bath: lint and rustfmt"
    command: bin/ci-builder run stable ci/test/lint-fast.sh
    inputs:
      - "*"
    timeout_in_minutes: 10

  - id: cargo-test
    label: ":cargo: test"
    depends_on: build-x86_64
    timeout_in_minutes: 30
    plugins:
      - ./ci/plugins/scratch-aws-access: ~
      - ./ci/plugins/mzcompose:
          composition: cargo-test
          run: app

  - id: testdrive
    label: ":racing_car: testdrive"
    depends_on: build-x86_64
    timeout_in_minutes: 30
    inputs: [test/testdrive]
    plugins:
      - ./ci/plugins/scratch-aws-access: ~
      - ./ci/plugins/mzcompose:
          composition: testdrive
          run: testdrive-ci

  - id: testdrive1
    label: ":racing_car: testdrive1"
    depends_on: build-x86_64
    timeout_in_minutes: 30
    inputs: [test/testdrive]
    plugins:
      - ./ci/plugins/scratch-aws-access: ~
      - ./ci/plugins/mzcompose:
          composition: testdrive
          run: testdrive-ci

  - id: testdrive2  
    label: ":racing_car: testdrive2"
    depends_on: build-x86_64
    timeout_in_minutes: 30
    inputs: [test/testdrive]
    plugins:
      - ./ci/plugins/scratch-aws-access: ~
      - ./ci/plugins/mzcompose:
          composition: testdrive
          run: testdrive-ci

  - id: testdrive3
    label: ":racing_car: testdrive3"
    depends_on: build-x86_64
    timeout_in_minutes: 30
    inputs: [test/testdrive]
    plugins:
      - ./ci/plugins/scratch-aws-access: ~
      - ./ci/plugins/mzcompose:
          composition: testdrive
          run: testdrive-ci

  - id: kafka-exactly-once
    label: "Test for the Kafka exactly-once sink"
    depends_on: build-x86_64
    plugins:
      - ./ci/plugins/mzcompose:
          composition: kafka-exactly-once
          run: kafka-exactly-once

  - id: persistence
    label: "Tests for persistence"
    depends_on: build-x86_64
    plugins:
      - ./ci/plugins/mzcompose:
          composition: persistence
          run: persistence
