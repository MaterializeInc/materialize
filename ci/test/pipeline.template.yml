# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

# This file is processed by mkpipeline.py to trim unnecessary steps in PR
# builds. The inputs for steps using the `mzcompose` plugin are computed
# automatically. Inputs for other steps need to be manually listed in the
# `inputs` key.

dag: true

env:
  CI_BAZEL_BUILD: 1
  CI_BAZEL_REMOTE_CACHE: $BAZEL_REMOTE_CACHE
  # Note: In .cargo/config we set the default build jobs to -1 so on developer machines we keep
  # a single core open when compiling. But we want to use all of CI's resources, hence setting the
  # build jobs to "default" which will use all cores.
  CARGO_BUILD_JOBS: "default"

# When resources are constrained, run early since this might be blocking a PR from merging
priority: 20

steps:
  - id: lint-docs
    label: Lint docs
    command: bin/ci-builder run stable ci/test/lint-docs.sh
    inputs:
      - doc/user
      - src/adapter/src/catalog
      - test/sqllogictest/autogenerated
    depends_on: []
    timeout_in_minutes: 30
    agents:
      # hugo: command not found
      queue: hetzner-x86-64-4cpu-8gb
    coverage: skip
    sanitizer: skip

  - id: preview-docs
    label: Preview docs
    command: bin/ci-builder run stable ci/test/preview-docs.sh
    inputs: [doc/user]
    depends_on: []
    timeout_in_minutes: 30
    agents:
      # hugo: command not found
      queue: linux-x86_64-small
    coverage: skip
    sanitizer: skip

  - id: docs-widgets-test
    label: Run Docs JS Widgets Tests
    command: bin/ci-builder run stable ci/test/docs-widgets/docs-widgets.sh
    inputs:
      - ci/test/docs-widgets/**
      - doc/user
    depends_on: []
    timeout_in_minutes: 15
    agents:
      queue: hetzner-aarch64-4cpu-8gb
    coverage: skip
    sanitizer: skip

  - wait: ~
    continue_on_failure: true

  - id: deploy-website
    label: Deploy website
    depends_on: lint-docs
    trigger: deploy-website
    async: true
    branches: "main self-managed-docs/*"
    build:
      commit: "$BUILDKITE_COMMIT"
      branch: "$BUILDKITE_BRANCH"
      env:
        BUILDKITE_TAG: "$BUILDKITE_TAG"
    coverage: skip
    sanitizer: skip
