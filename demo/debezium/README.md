# Debezium Demonstrations

This directory contains an mzcompose workflow for spinning up a MySQL database, replicated to
Kafka via Debezium, accesible to a Materialize instance. To get started, run:

```sh
./mzcompose run demo
```

Once the above workflow completes, you can access the MySQL database using:

```sh
./mzcompose run mysqlcli
```

You can then follow the steps in the [A Simple Transaction][] section to see what messages are
generated by Debezium.

## Topics Created by Debezium

### dbserver1

This topic contains schema information from the connector, as well as DDL
statements? JSON formatted. Use the schema-changes.inventory topic if you want
to follow schema changes, as this topic is considered internal to the
connector.

### dbserver1.inventory.*

Topics that represent the actual tables. AVRO formatted.

### schema-changes.inventory

DDL changes to the schemas in MySQL. JSON formatted. This [Schema Change
Topic](https://debezium.io/documentation/reference/connectors/mysql.html#mysql-schema-change-topic)
is intended for application consumption, as opposed to the internal [Schema History
Topic](https://debezium.io/documentation/reference/connectors/mysql.html#mysql-schema-history-topic).

### connect_offsets

Internal topic so that the connector knows how far into the binlog it has read.
For example:

```json
[
  "inventory-connector",
  {
    "server": "dbserver1"
  }
]
{
  "file": "mysql-bin.000003",
  "pos": 154
}
```

## A Sample Transaction

```sql
start transaction;
insert into customers (first_name, last_name, email) values ('Chris', 'Golden', 'chris@materialize.com');
update products_on_hand set quantity = quantity + 1 where quantity < 20;
commit;
```

And now to look at the Debezium messages generated by the above...

First, `connect_offsets` will have a new entry:

```json
[
  "inventory-connector",
  {
    "server": "dbserver1"
  }
]
{
  "ts_sec": 1617908742,
  "file": "mysql-bin.000003",
  "pos": 219,
  "row": 8,
  "server_id": 223344,
  "event": 4
}
```

There will be a new transaction:

```json
{
  "id": "file=mysql-bin.000003,pos=219"
}
{
  "status": "END",
  "id": "file=mysql-bin.000003,pos=219",
  "event_count": {
    "long": 9
  },
  "data_collections": {
    "array": [
      {
        "data_collection": "inventory.products_on_hand",
        "event_count": 8
      },
      {
        "data_collection": "inventory.customers",
        "event_count": 1
      }
    ]
  }
}
```

There will also be a new message in `dbserver1.inventory.customers` (before is null because we
inserted a new row into customers):

```json
{
  "id": 1005
}
{
  "before": null,
  "after": {
    "Value": {
      "id": 1005,
      "first_name": "Chris",
      "last_name": "Golden",
      "email": "chris@materialize.com"
    }
  },
  "source": {
    "version": "1.5.0.Final",
    "connector": "mysql",
    "name": "dbserver1",
    "ts_ms": 1617911896000,
    "snapshot": {
      "string": "false"
    },
    "db": "inventory",
    "sequence": null,
    "table": {
      "string": "customers"
    },
    "server_id": 223344,
    "gtid": null,
    "file": "mysql-bin.000003",
    "pos": 364,
    "row": 0,
    "thread": null,
    "query": null
  },
  "op": "c",
  "ts_ms": {
    "long": 1617911896494
  },
  "transaction": {
    "ConnectDefault": {
      "id": "file=mysql-bin.000003,pos=219",
      "total_order": 1,
      "data_collection_order": 1
    }
  }
}
```

And several new messages in `dbserver1.inventory.products_on_hand`. Let's look at one example:

```json
{
  "product_id": 101
}
{
  "before": {
    "Value": {
      "product_id": 101,
      "quantity": 3
    }
  },
  "after": {
    "Value": {
      "product_id": 101,
      "quantity": 4
    }
  },
  "source": {
    "version": "1.5.0.Final",
    "connector": "mysql",
    "name": "dbserver1",
    "ts_ms": 1617911896000,
    "snapshot": {
      "string": "false"
    },
    "db": "inventory",
    "sequence": null,
    "table": {
      "string": "products_on_hand"
    },
    "server_id": 223344,
    "gtid": null,
    "file": "mysql-bin.000003",
    "pos": 504,
    "row": 0,
    "thread": null,
    "query": null
  },
  "op": "u",
  "ts_ms": {
    "long": 1617911896497
  },
  "transaction": {
    "ConnectDefault": {
      "id": "file=mysql-bin.000003,pos=219",
      "total_order": 2,
      "data_collection_order": 1
    }
  }
}
```

Notice the before is populated because we modified an existing row.

## Open questions

### Does the total order field matter?

Perhaps this field is used to identify duplicate messages within a transaction? Running the following:

```sql
start transaction;
update customers set first_name = 'chris', last_name = 'golden' where email = 'chris@materialize.io';
update customers set first_name = 'Chris', last_name = 'Golden' where email = 'chris@materialize.io';
update customers set first_name = 'chris', last_name = 'golden' where email = 'chris@materialize.io';
commit;
```

Results in 3 messages, where the difference between messages 1 and 3 are fields:

- `.source.ts_ms`
- `.source.pos`
- `.transaction.total_order`
- `.transaction.data_collection_order`
- `.ts_ms`

### At Least Once Write Behavior

Is this true?

```
If Debezium goes backwards, it should always write to the tip of the topic
like it's not gonna write "1, 2, 3, 4, 5, 6, 2, 3, 4" but rather "1, 2, 3, 4, 5, 6, 2, 3, 4, 5, 6"
```

## Reading Messages Using Kafkacat

Now that you've started the demo, you can read the raw messages from Kafka
using kafkacat:

```sh
kafkacat -C -b localhost:9092 -s avro -r localhost:8081 -t debezium.inventory.customers -e
{"id": 1001}{"before": null, "after": {"Value": {"id": 1001, "first_name": "Sally", "last_name": "Thomas", "email": "sally.thomas@acme.com"}}, "source": {"version": "1.4.2.Final", "connector": "mysql", "name": "debezium", "ts_ms": 0, "snapshot": {"string": "true"}, "db": "inventory", "table": {"string": "customers"}, "server_id": 0, "gtid": null, "file": "mysql-bin.000003", "pos": 154, "row": 0, "thread": null, "query": null}, "op": "r", "ts_ms": {"long": 1617830680716}, "transaction": null}
{"id": 1002}{"before": null, "after": {"Value": {"id": 1002, "first_name": "George", "last_name": "Bailey", "email": "gbailey@foobar.com"}}, "source": {"version": "1.4.2.Final", "connector": "mysql", "name": "debezium", "ts_ms": 0, "snapshot": {"string": "true"}, "db": "inventory", "table": {"string": "customers"}, "server_id": 0, "gtid": null, "file": "mysql-bin.000003", "pos": 154, "row": 0, "thread": null, "query": null}, "op": "r", "ts_ms": {"long": 1617830680717}, "transaction": null}
{"id": 1003}{"before": null, "after": {"Value": {"id": 1003, "first_name": "Edward", "last_name": "Walker", "email": "ed@walker.com"}}, "source": {"version": "1.4.2.Final", "connector": "mysql", "name": "debezium", "ts_ms": 0, "snapshot": {"string": "true"}, "db": "inventory", "table": {"string": "customers"}, "server_id": 0, "gtid": null, "file": "mysql-bin.000003", "pos": 154, "row": 0, "thread": null, "query": null}, "op": "r", "ts_ms": {"long": 1617830680717}, "transaction": null}
{"id": 1004}{"before": null, "after": {"Value": {"id": 1004, "first_name": "Anne", "last_name": "Kretchmar", "email": "annek@noanswer.org"}}, "source": {"version": "1.4.2.Final", "connector": "mysql", "name": "debezium", "ts_ms": 0, "snapshot": {"string": "true"}, "db": "inventory", "table": {"string": "customers"}, "server_id": 0, "gtid": null, "file": "mysql-bin.000003", "pos": 154, "row": 0, "thread": null, "query": null}, "op": "r", "ts_ms": {"long": 1617830680717}, "transaction": null}
% Reached end of topic debezium.inventory.customers [0] at offset 4: exiting
```

## Importing Tables in Materialized

If you want to import the tables by hand, you can use the following SQL
statement:

```sql
CREATE MATERIALIZED SOURCE IF NOT EXISTS customers
FROM KAFKA BROKER 'kafka:9092' TOPIC 'debezium.inventory.customers'
FORMAT AVRO USING CONFLUENT SCHEMA REGISTRY 'http://schema-registry:8081'
ENVELOPE DEBEZIUM;
```
