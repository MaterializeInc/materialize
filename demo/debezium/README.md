# Debezium Demonstrations

This directory contains an mzcompose workflow for spinning up a MySQL database, replicated to
Kafka via Debezium, accesible to a Materialize instance. To get started, run:

```sh
./mzcompose run demo
```

Once the above workflow completes, you can access the MySQL database using:

```sh
./mzcompose run mysqlcli
```

You can then follow the steps in the [A Simple Transaction][] section to see what messages are
generated by Debezium.

## Topics Created by Debezium

### dbserver1

This topic contains schema information from the connector, as well as DDL
statements? JSON formatted. Use the schema-changes.inventory topic if you want
to follow schema changes, as this topic is considered internal to the
connector.

### dbserver1.inventory.*

Topics that represent the actual tables. AVRO formatted.

### schema-changes.inventory

DDL changes to the schemas in MySQL. JSON formatted. This [Schema Change
Topic](https://debezium.io/documentation/reference/connectors/mysql.html#mysql-schema-change-topic)
is intended for application consumption, as opposed to the internal [Schema History
Topic](https://debezium.io/documentation/reference/connectors/mysql.html#mysql-schema-history-topic).

### connect_offsets

Internal topic so that the connector knows how far into the binlog it has read.
For example:

```json
[
  "inventory-connector",
  {
    "server": "dbserver1"
  }
]
{
  "file": "mysql-bin.000003",
  "pos": 154
}
```

## A Sample Transaction

```sql
start transaction;
insert into customers (first_name, last_name, email) values ('Chris', 'Golden', 'chris@materialize.com');
update products_on_hand set quantity = quantity + 1 where quantity < 20;
commit;
```

And now to look at the Debezium messages generated by the above...

First, `connect_offsets` will have a new entry:

```json
[
  "inventory-connector",
  {
    "server": "dbserver1"
  }
]
{
  "ts_sec": 1617908742,
  "file": "mysql-bin.000003",
  "pos": 219,
  "row": 8,
  "server_id": 223344,
  "event": 4
}
```

There will be a new transaction:

```json
{
  "id": "file=mysql-bin.000003,pos=219"
}
{
  "status": "END",
  "id": "file=mysql-bin.000003,pos=219",
  "event_count": {
    "long": 9
  },
  "data_collections": {
    "array": [
      {
        "data_collection": "inventory.products_on_hand",
        "event_count": 8
      },
      {
        "data_collection": "inventory.customers",
        "event_count": 1
      }
    ]
  }
}
```

There will also be a new message in `dbserver1.inventory.customers` (before is null because we
inserted a new row into customers):

```json
{
  "id": 1005
}
{
  "before": null,
  "after": {
    "Value": {
      "id": 1005,
      "first_name": "Chris",
      "last_name": "Golden",
      "email": "chris@materialize.com"
    }
  },
  "source": {
    "version": "1.5.0.Final",
    "connector": "mysql",
    "name": "dbserver1",
    "ts_ms": 1617911896000,
    "snapshot": {
      "string": "false"
    },
    "db": "inventory",
    "sequence": null,
    "table": {
      "string": "customers"
    },
    "server_id": 223344,
    "gtid": null,
    "file": "mysql-bin.000003",
    "pos": 364,
    "row": 0,
    "thread": null,
    "query": null
  },
  "op": "c",
  "ts_ms": {
    "long": 1617911896494
  },
  "transaction": {
    "ConnectDefault": {
      "id": "file=mysql-bin.000003,pos=219",
      "total_order": 1,
      "data_collection_order": 1
    }
  }
}
```

And several new messages in `dbserver1.inventory.products_on_hand`. Let's look at one example:

```json
{
  "product_id": 101
}
{
  "before": {
    "Value": {
      "product_id": 101,
      "quantity": 3
    }
  },
  "after": {
    "Value": {
      "product_id": 101,
      "quantity": 4
    }
  },
  "source": {
    "version": "1.5.0.Final",
    "connector": "mysql",
    "name": "dbserver1",
    "ts_ms": 1617911896000,
    "snapshot": {
      "string": "false"
    },
    "db": "inventory",
    "sequence": null,
    "table": {
      "string": "products_on_hand"
    },
    "server_id": 223344,
    "gtid": null,
    "file": "mysql-bin.000003",
    "pos": 504,
    "row": 0,
    "thread": null,
    "query": null
  },
  "op": "u",
  "ts_ms": {
    "long": 1617911896497
  },
  "transaction": {
    "ConnectDefault": {
      "id": "file=mysql-bin.000003,pos=219",
      "total_order": 2,
      "data_collection_order": 1
    }
  }
}
```

Notice the before is populated because we modified an existing row.

## Open questions

### Does the total order field matter?

Perhaps this field is used to identify duplicate messages within a transaction? Running the following:

```sql
start transaction;
update customers set first_name = 'chris', last_name = 'golden' where email = 'chris@materialize.io';
update customers set first_name = 'Chris', last_name = 'Golden' where email = 'chris@materialize.io';
update customers set first_name = 'chris', last_name = 'golden' where email = 'chris@materialize.io';
commit;
```

Results in 3 messages, where the difference between messages 1 and 3 are fields:

- `.source.ts_ms`
- `.source.pos`
- `.transaction.total_order`
- `.transaction.data_collection_order`
- `.ts_ms`

### At Least Once Write Behavior

Is this true?

```
If Debezium goes backwards, it should always write to the tip of the topic
like it's not gonna write "1, 2, 3, 4, 5, 6, 2, 3, 4" but rather "1, 2, 3, 4, 5, 6, 2, 3, 4, 5, 6"
```

## Reading Messages Using Kafkacat

Now that you've started the demo, you can read the raw messages from Kafka
using kafkacat:

```sh
kafkacat -C -b localhost:9092 -s avro -r localhost:8081 -t debezium.inventory.customers -e
{"id": 1001}{"before": null, "after": {"Value": {"id": 1001, "first_name": "Sally", "last_name": "Thomas", "email": "sally.thomas@acme.com"}}, "source": {"version": "1.4.2.Final", "connector": "mysql", "name": "debezium", "ts_ms": 0, "snapshot": {"string": "true"}, "db": "inventory", "table": {"string": "customers"}, "server_id": 0, "gtid": null, "file": "mysql-bin.000003", "pos": 154, "row": 0, "thread": null, "query": null}, "op": "r", "ts_ms": {"long": 1617830680716}, "transaction": null}
{"id": 1002}{"before": null, "after": {"Value": {"id": 1002, "first_name": "George", "last_name": "Bailey", "email": "gbailey@foobar.com"}}, "source": {"version": "1.4.2.Final", "connector": "mysql", "name": "debezium", "ts_ms": 0, "snapshot": {"string": "true"}, "db": "inventory", "table": {"string": "customers"}, "server_id": 0, "gtid": null, "file": "mysql-bin.000003", "pos": 154, "row": 0, "thread": null, "query": null}, "op": "r", "ts_ms": {"long": 1617830680717}, "transaction": null}
{"id": 1003}{"before": null, "after": {"Value": {"id": 1003, "first_name": "Edward", "last_name": "Walker", "email": "ed@walker.com"}}, "source": {"version": "1.4.2.Final", "connector": "mysql", "name": "debezium", "ts_ms": 0, "snapshot": {"string": "true"}, "db": "inventory", "table": {"string": "customers"}, "server_id": 0, "gtid": null, "file": "mysql-bin.000003", "pos": 154, "row": 0, "thread": null, "query": null}, "op": "r", "ts_ms": {"long": 1617830680717}, "transaction": null}
{"id": 1004}{"before": null, "after": {"Value": {"id": 1004, "first_name": "Anne", "last_name": "Kretchmar", "email": "annek@noanswer.org"}}, "source": {"version": "1.4.2.Final", "connector": "mysql", "name": "debezium", "ts_ms": 0, "snapshot": {"string": "true"}, "db": "inventory", "table": {"string": "customers"}, "server_id": 0, "gtid": null, "file": "mysql-bin.000003", "pos": 154, "row": 0, "thread": null, "query": null}, "op": "r", "ts_ms": {"long": 1617830680717}, "transaction": null}
% Reached end of topic debezium.inventory.customers [0] at offset 4: exiting
```

### Getting the List of Transaction IDs

Use the transaction topic to generate the list of transactions, in commit order:

```sh
[chris-work:~/materialize/materialize:(main[|]*)] kafkacat -C -b localhost:9092 -r localhost:8081 -s avro -t dbserver1.transaction -e -f "Partition: %p\tOffset: %o\t: %k\n"
Partition: 0    Offset: 0       : {"id": "file=mysql-bin.000003,pos=2201"}
Partition: 0    Offset: 1       : {"id": "file=mysql-bin.000003,pos=2201"}
Partition: 0    Offset: 2       : {"id": "file=mysql-bin.000003,pos=3491"}
Partition: 0    Offset: 3       : {"id": "file=mysql-bin.000003,pos=3491"}
Partition: 0    Offset: 4       : {"id": "file=mysql-bin.000003,pos=4397"}
Partition: 0    Offset: 5       : {"id": "file=mysql-bin.000003,pos=4397"}
Partition: 0    Offset: 6       : {"id": "file=mysql-bin.000003,pos=5506"}
Partition: 0    Offset: 7       : {"id": "file=mysql-bin.000003,pos=5506"}
Partition: 0    Offset: 8       : {"id": "file=mysql-bin.000003,pos=6250"}
Partition: 0    Offset: 9       : {"id": "file=mysql-bin.000003,pos=6250"}
Partition: 0    Offset: 10      : {"id": "file=mysql-bin.000003,pos=6710"}
Partition: 0    Offset: 11      : {"id": "file=mysql-bin.000003,pos=6710"}
Partition: 0    Offset: 12      : {"id": "file=mysql-bin.000003,pos=7397"}
Partition: 0    Offset: 13      : {"id": "file=mysql-bin.000003,pos=7397"}
Partition: 0    Offset: 14      : {"id": "file=mysql-bin.000003,pos=7819"}
Partition: 0    Offset: 15      : {"id": "file=mysql-bin.000003,pos=7819"}
Partition: 0    Offset: 16      : {"id": "file=mysql-bin.000003,pos=9048"}
Partition: 0    Offset: 17      : {"id": "file=mysql-bin.000003,pos=9048"}
Partition: 0    Offset: 18      : {"id": "file=mysql-bin.000003,pos=10238"}
Partition: 0    Offset: 19      : {"id": "file=mysql-bin.000003,pos=10238"}
Partition: 0    Offset: 20      : {"id": "file=mysql-bin.000003,pos=10944"}
Partition: 0    Offset: 21      : {"id": "file=mysql-bin.000003,pos=10944"}
Partition: 0    Offset: 22      : {"id": "file=mysql-bin.000003,pos=11591"}
Partition: 0    Offset: 23      : {"id": "file=mysql-bin.000003,pos=11591"}
Partition: 0    Offset: 24      : {"id": "file=mysql-bin.000003,pos=12248"}
Partition: 0    Offset: 25      : {"id": "file=mysql-bin.000003,pos=12248"}
Partition: 0    Offset: 26      : {"id": "file=mysql-bin.000003,pos=13065"}
Partition: 0    Offset: 27      : {"id": "file=mysql-bin.000003,pos=13065"}
Partition: 0    Offset: 28      : {"id": "file=mysql-bin.000003,pos=13941"}
Partition: 0    Offset: 29      : {"id": "file=mysql-bin.000003,pos=13941"}
Partition: 0    Offset: 30      : {"id": "file=mysql-bin.000003,pos=14480"}
Partition: 0    Offset: 31      : {"id": "file=mysql-bin.000003,pos=14480"}
```

You can then list another topic, and you'll see 5 types of messages:

- Initial snapshot of data, (.before is null, .after is non null) -- no transaction ID,
- Creates,(.before is null, .after is non null) -- transaction ID is supplied
- Updates (.before and .after are both non null) -- transaction ID is supplied
- Deletes (.before is non null, .after is null) -- transaction ID is supplied
- Tombstone messages, entire value is empty -- no transaction ID because no value

You might see something like:

```sh
{"id": 1003}{"before": null, "after": {"Value": {"id": 1003, "first_name": "Edward", "last_name": "Walker", "email": "ed@walker.com"}}, "source": {"version": "1.5.0.Final", "connector": "mysql", "name": "dbserver1", "ts_ms": 1619121065623, "snapshot": {"string": "true"}, "db": "inventory", "sequence": null, "table": {"string": "customers"}, "server_id": 0, "gtid": null, "file": "mysql-bin.000003", "pos": 154, "row": 0, "thread": null, "query": null}, "op": "r", "ts_ms": {"long": 1619121065623}, "transaction": null}
{"id": 1003}{"before": {"Value": {"id": 1003, "first_name": "Edward", "last_name": "Walker", "email": "ed@walker.com"}}, "after": null, "source": {"version": "1.5.0.Final", "connector": "mysql", "name": "dbserver1", "ts_ms": 1619121079000, "snapshot": {"string": "false"}, "db": "inventory", "sequence": null, "table": {"string": "customers"}, "server_id": 223344, "gtid": null, "file": "mysql-bin.000003", "pos": 7542, "row": 0, "thread": null, "query": null}, "op": "d", "ts_ms": {"long": 1619121080079}, "transaction": {"ConnectDefault": {"id": "file=mysql-bin.000003,pos=7397", "total_order": 1, "data_collection_order": 1}}}
{"id": 1003}
% Reached end of topic dbserver1.inventory.customers [0] at offset 28: exiting
```

The first message is the initial load, the second is an delete and the third is a tombstone for
both records.

#### Messages in Transaction ID Order

For messages with transaction IDs, they are presented in order of the transaction ID presented in
the transaction topic.

## Importing Tables in Materialized

If you want to import the tables by hand, you can use the following SQL
statement:

```sql
CREATE MATERIALIZED SOURCE IF NOT EXISTS customers
FROM KAFKA BROKER 'kafka:9092' TOPIC 'debezium.inventory.customers'
FORMAT AVRO USING CONFLUENT SCHEMA REGISTRY 'http://schema-registry:8081'
ENVELOPE DEBEZIUM;
```

You can even import the transaction topic if you want to take a look at it!

```sql
CREATE MATERIALIZED SOURCE IF NOT EXISTS dbz_transactions
FROM KAFKA BROKER 'kafka:9092' TOPIC 'dbserver1.transaction'
FORMAT AVRO USING CONFLUENT SCHEMA REGISTRY 'http://schema-registry:8081';
```

This will give something like the following:

```sql
materialize=> select * from dbz_transactions order by id limit 4;
 status |               id                | event_count |                                               data_collections
--------+---------------------------------+-------------+--------------------------------------------------------------------------------------------------------------
 BEGIN  | file=mysql-bin.000003,pos=10668 |             |
 END    | file=mysql-bin.000003,pos=10668 |           5 | {"(inventory.products_on_hand,1)","(inventory.addresses,1)","(inventory.orders,2)","(inventory.products,1)"}
 BEGIN  | file=mysql-bin.000003,pos=11483 |             |
 END    | file=mysql-bin.000003,pos=11483 |           2 | {"(inventory.products_on_hand,1)","(inventory.customers,1)"}
```

## Restarting Debezium (Postgres edition)

If you restart Debezium, in the middle of running chbench, you'll see something like the following
in the logs:

```
2021-05-07 04:59:25,186 INFO   Postgres|debezium|postgres-connector-task  Searching for WAL resume position   [io.debezium.connector.postgresql.PostgresStreamingChangeEventSource]
2021-05-07 04:59:29,770 INFO   Postgres|debezium|postgres-connector-task  First LSN 'LSN{0/13741C98}' received   [io.debezium.connector.postgresql.connection.WalPositionLocator]
2021-05-07 04:59:29,779 INFO   Postgres|debezium|postgres-connector-task  LSN after last stored change LSN 'LSN{0/13741CC0}' received   [io.debezium.connector.postgresql.connection.WalPositionLocator]
2021-05-07 04:59:29,779 INFO   Postgres|debezium|postgres-connector-task  WAL resume position 'LSN{0/13741CC0}' discovered   [io.debezium.connector.postgresql.PostgresStreamingChangeEventSource]
2021-05-07 04:59:29,780 INFO   Postgres|debezium|postgres-connector-task  Connection gracefully closed   [io.debezium.jdbc.JdbcConnection]
2021-05-07 04:59:29,800 INFO   Postgres|debezium|postgres-connector-task  Processing messages   [io.debezium.connector.postgresql.PostgresStreamingChangeEventSource]
2021-05-07 04:59:30,815 INFO   Postgres|debezium|postgres-connector-task  Streaming requested from LSN LSN{0/13741C98}, received LSN LSN{0/13741C98} identified as already processed   [io.debezium.connector.postgresql.connection.AbstractMessageDecoder]
2021-05-07 04:59:30,816 INFO   Postgres|debezium|postgres-connector-task  Message with LSN 'LSN{0/13741CC0}' arrived, switching off the filtering   [io.debezium.connector.postgresql.connection.WalPositionLocator]
```

It appears that this resulted in a single transaction's END message (`130681`)
being repeated:

```
2021-05-07T05:13:33.840383Z  INFO validate_debezium_topics: validating DebeziumTransaction {
    id: "130649",
    status: BEGIN,
}
2021-05-07T05:13:33.840392Z  INFO validate_debezium_topics: validating DebeziumTransaction {
    id: "130649",
    status: END {
        txinfo: DebeziumTransactionInfo {
            event_count: 31,
            collections: {
                "tpcch.neworder": 1,
                "tpcch.district": 1,
                "tpcch.orderline": 14,
                "tpcch.order": 1,
                "tpcch.stock": 14,
            },
        },
    },
}
2021-05-07T05:13:33.840417Z  INFO validate_debezium_topics: validating DebeziumTransaction {
    id: "130681",
    status: BEGIN,
}
2021-05-07T05:13:33.840425Z  INFO validate_debezium_topics: validating DebeziumTransaction {
    id: "130681",
    status: END {
        txinfo: DebeziumTransactionInfo {
            event_count: 4,
            collections: {
                "tpcch.district": 1,
                "tpcch.customer": 1,
                "tpcch.warehouse": 1,
                "tpcch.history": 1,
            },
        },
    },
}
2021-05-07T05:13:33.840450Z  INFO validate_debezium_topics: validating DebeziumTransaction {
    id: "130681",
    status: END {
        txinfo: DebeziumTransactionInfo {
            event_count: 4,
            collections: {
                "tpcch.history": 1,
                "tpcch.district": 1,
                "tpcch.customer": 1,
                "tpcch.warehouse": 1,
            },
        },
    },
}
2021-05-07T05:13:33.840472Z  INFO validate_debezium_topics: tx_id 130681 repeated!
2021-05-07T05:13:33.840480Z  INFO validate_debezium_topics: validating DebeziumTransaction {
    id: "130686",
    status: BEGIN,
}
2021-05-07T05:13:33.840488Z  INFO validate_debezium_topics: validating DebeziumTransaction {
    id: "130686",
    status: END {
        txinfo: DebeziumTransactionInfo {
            event_count: 19,
            collections: {
                "tpcch.order": 1,
                "tpcch.neworder": 1,
                "tpcch.stock": 8,
                "tpcch.district": 1,
                "tpcch.orderline": 8,
            },
        },
    },
}
```
