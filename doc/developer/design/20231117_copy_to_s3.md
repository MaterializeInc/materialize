# AWS Connection

## The Problem

Github issue:  [Issue 7256](https://github.com/MaterializeInc/materialize/issues/7256)

As an operational data warehouse, Materialize sits upstream of a traditional data warehouse
for our customers. The data brought in to Materialize will serve not only operational workloads,
but ultimately analytical ones. This means our customers can benefit from a cheap and
user-friendly method to share their data or send it on to the tools purpose-built for
their analytical workloads while reducing the need to duplicate transformation logic
across operational and analytical data warehouses. A full copy of data from Materialize
into S3 is a simple and intuitive way to enable this for our customers.

## Goals
- Be able to run a sql command to write a snapshot of a materialized view or a table (persist backed items) to S3.
- Initially the scope will be limited to only parquet as an output format.
- Users should be able to get a response back indicating some information about the data written to S3, for e.g., number of rows, bytes transferred etc.

## Non-goals
- Support arbitrary select queries like `COPY (SELECT ...) TO S3` in the initial version.

## Solution Proposal
In materialize we already have some support for `COPY`
commands. We should expand upon them, keeping them as close to
the [postgres syntax](https://www.postgresql.org/docs/current/sql-copy.html).

### SQL
The SQL could look like the following.

```sql
COPY <mv_name> -- mv or table name
TO s3://prefix/path
USING AWS CONNECTION aws_conn -- previously created aws connection
WITH (
  FORMAT = 'parquet', -- only parquet support for the time being
  MAX FILE SIZE = '2g' -- config to limit file sizes in s3
)
```

### User Experience
- Customer will need to first set up an [AWS connection](../design/20231110_aws_connections.md) and use
`VALIDATE CONNECTION` to check that it's working
-

## Implementation


## Rollout and Testing
We should put COPY TO S3 behind a feature flag.

#### Testing During development
TODO: Check with how we do persist tests

#### Testing after code is merged
Switch on the feature flag for the staging environment and do an end to end copy to s3
flow in staging.

## Future work

####