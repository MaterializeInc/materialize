{{ $orchestratord_version := site.Data.self_managed.latest_versions.orchestratord_version }}
{{ $environmentd_version :=
site.Data.self_managed.latest_versions.environmentd_version }}
{{ $operator_version :=
site.Data.self_managed.latest_versions.operator_helm_chart_version }}

1. Open a Terminal window.

1. Go to your Materialize working directory.

   ```shell
   cd my-local-mz
   ```

1. Upgrade the Materialize Helm chart.

   ```shell
   helm repo update materialize
   ```

1. Get the sample configuration files for the new version.

   ```shell
   mz_operator_version={{ $orchestratord_version }}

   curl -o upgrade-values.yaml https://raw.githubusercontent.com/MaterializeInc/materialize/refs/tags/$mz_operator_version/misc/helm-charts/operator/values.yaml
   ```

   If you have previously modified the `values.yaml` file for your deployment,
   include the changes into the `upgrade-values.yaml` file.

1. Upgrade the Materialize Operator, specifying the new version and the updated
   configuration file. Include any additional configurations that you specify
   for your deployment.

   ```shell
   helm upgrade my-materialize-operator materialize/materialize-operator \
   --namespace=materialize \
   --version {{ $operator_version }} \
   -f upgrade-values.yaml \
   --set operator.cloudProvider.region=minikube \
   --set observability.podMetrics.enabled=true
   ```

1. Verify that the operator is running:

   ```bash
   kubectl -n materialize get all
   ```

   Verify the operator upgrade by checking its events:

   ```bash
   MZ_OPERATOR=$(kubectl -n materialize get pods --no-headers | grep operator  | awk '{print $1}')
   kubectl -n materialize describe pod/$MZ_OPERATOR
   ```

1. Create a new `upgrade-materialize.yaml` file with the following content:

   | Field | Description |
   |-------|-------------|
   | `environmentdImageRef` | Update the version to the new version. |
   | `requestRollout` or `forceRollout`| Enter a new UUID. Can be generated with `uuidgen`. <br> <ul><li>`requestRollout` triggers a rollout only if changes exist. </li><li>`forceRollout` triggers a rollout even if no changes exist.</li></ul> |
   | `inPlaceRollout` | Set to `true` to perform an in-place upgrade.<br>Set to `false` to perform a rolling upgrade. For rolling upgrades, ensure you have enough resources to support having both the old and new Materialize instances running during the upgrade. |

   ```yaml
   apiVersion: materialize.cloud/v1alpha1
   kind: Materialize
   metadata:
     name: 12345678-1234-1234-1234-123456789012
     namespace: materialize-environment
   spec:
     environmentdImageRef: materialize/environmentd:{{ $environmentd_version }} # Update version
     requestRollout: 22222222-2222-2222-2222-222222222222    # Enter a new UUID
     # forceRollout: 33333333-3333-3333-3333-333333333333    # For forced rollouts
     inPlaceRollout: true                                   # When false,  performs a rolling upgrade rather than in-place
     backendSecretName: materialize-backend
   ```

1. Apply the upgrade-materialize.yaml file to your Materialize instance:

   ```shell
   kubectl apply -f upgrade-materialize.yaml
   ```

1. Verify that the components are running after the upgrade:

   ```bash
   kubectl -n materialize-environment get all
   ```

   Verify upgrade by checking the `balancerd` events:

   ```bash
   MZ_BALANCERD=$(kubectl -n materialize-environment get pods --no-headers | grep balancerd  | awk '{print $1}')
   kubectl -n materialize-environment describe pod/$MZ_BALANCERD
   ```

   The **Events** section should list that the new version of the `balancerd`
   have been pulled.

   Verify the upgrade by checking the `environmentd` events:

   ```bash
   MZ_ENVIRONMENTD=$(kubectl -n materialize-environment get pods --no-headers | grep environmentd  | awk '{print $1}')
   kubectl -n materialize-environment describe pod/$MZ_ENVIRONMENTD
   ```

   The **Events** section should list that the new version of the `environmentd`
   have been pulled.

1. Open the Materialize Console. The Console should display the new version.
