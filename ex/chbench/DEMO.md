# tpcch metabase demo

## Initial Setup

### Get metabase running

* run `dc.sh up :init:`
* run `dc.sh up :demo:`

### Set up a metabase dashboard

* Ensure that the database schema is up to date:
  1. visit `admin/databases`
  2. click on the materialize database you created
  3. click "sync database schema now" on the top right
  4. You're done, go back to the `/` path
* Click the "ask a question" button, which takes you to `/question/new`
* Click on native query, which generates a url with a bunch of autogenerated unique IDs.
* Ensure that the tpcch sources exist: `SHOW SOURCES` and press the play button.
  * if they *don't*, then you can enter the create sources query here:

        CREATE SOURCES LIKE 'mysql.tpcch.%' FROM 'kafka://kafka:9092' USING SCHEMA REGISTRY 'http://schema-registry:8081';

    and press play.

* Paste in a query, e.g. tpch query 1:

      SELECT
          ol_number,
          sum(ol_quantity) AS sum_qty,
          sum(ol_amount) AS sum_amount,
          avg(ol_quantity) AS avg_qty,
          avg(ol_amount) AS avg_amount,
          count(*) AS count_order
      FROM mysql_tpcch_orderline
      WHERE ol_delivery_d > TIMESTAMP '2007-01-02 00:00:00.000000'
      GROUP BY ol_number
      ORDER BY ol_number

* Save this:
  1. click on the save button on the top-right and entering the name `tpcch-q01 (without
     view)`

  1. When asked to add to a dashboard click "Yes"
     * If you've never created a dashboard follow the steps to create a dashboard named
       "TPC-CH Demo" in your personal collection
     * Otherwise just add it to that previously-created dashboard
* Now we want to to create the same query, but just selecting from a view. So what we do
  is we past this into the "ask a question" box:

      CREATE VIEW q01 AS
      SELECT
          ol_number,
          sum(ol_quantity) AS sum_qty,
          sum(ol_amount) AS sum_amount,
          avg(ol_quantity) AS avg_qty,
          avg(ol_amount) AS avg_amount,
          count(*) AS count_order
      FROM mysql_tpcch_orderline
      WHERE ol_delivery_d > TIMESTAMP '2007-01-02 00:00:00.000000'
      GROUP BY ol_number
      ORDER BY ol_number

  and press play. This will give you an error! That is fine.
* Now we put this in the box:

      SELECT * FROM q01

  That should be pretty fast.
* Now go back to the "Save this:" steps above, except with a different name suffix:
  `tpcch-q01 (from view)`
* We also want to show that the count of things is changing, so we should do:

    CREATE VIEW orderline_count AS SELECT count(*) FROM mysql_tpcch_orderline;

* and then save a question that looks like, and add it to that same dashboard:

    SELECT * FROM orderline_count

Now we want to do this a few different views, see the end of this document for some thing that can be copy/pasted.

## Running the demo

Go back to the "browse data" (the materialize db from `/browse`) screen, some talking
points:

* We are a streaming data engine that is capable of supporting all of SQL, with strong
  consistency guarnatees. The only thing left at this point is engineering effort.
* To show you where we are now we're going to walk through just using a regular BI tool
  in the way that a regular analyst would use it, but then show the power of materialize
  maintaining streaming views.
* I'd click the lightning bolt next to `Mysql Tpcch Order Line` just sort of to demo that
  we do in fact support a variety of things.

  Talking points: these are just a variety of non-join queries that we support, but the
  point is that this un-hacked BI tool just works with us, and we'll work with them to
  make sure that their BI tool of choice also works with us.
* Then I'd go and ask a simple question to demonstrate that we can work with the standard
  analytics interfaces.
* Then go to our dashboard
* Then you can run the demo-load generator:

    dc.sh demo-load

* And manually reload (issue #1286) the dashboard to watch things changing.

## Appendix: TPC-CH Queries

* `q02`:

      SELECT su_suppkey, su_name, n_name, i_id, i_name, su_address, su_phone, su_comment
      FROM
          mysql_tpcch_item,
          mysql_tpcch_supplier,
          mysql_tpcch_stock,
          mysql_tpcch_nation,
          mysql_tpcch_region,
          (
              SELECT
                  s_i_id AS m_i_id,
                  min(s_quantity) AS m_s_quantity
              FROM
                  mysql_tpcch_stock,
                  mysql_tpcch_supplier,
                  mysql_tpcch_nation,
                  mysql_tpcch_region
              WHERE s_su_suppkey = su_suppkey
              AND su_nationkey = n_nationkey
              AND n_regionkey = r_regionkey
              AND r_name like 'EUROP%'
              GROUP BY s_i_id
          ) m
      WHERE i_id = s_i_id
      AND s_su_suppkey = su_suppkey
      AND su_nationkey = n_nationkey
      AND n_regionkey = r_regionkey
      AND i_data like '%b'
      AND r_name like 'EUROP%'
      AND i_id = m_i_id
      AND s_quantity = m_s_quantity
      ORDER BY n_name, su_name, i_id

* `q03`:

      SELECT ol_o_id, ol_w_id, ol_d_id, sum(ol_amount) AS revenue, o_entry_d
      FROM
          mysql_tpcch_customer,
          mysql_tpcch_neworder,
          mysql_tpcch_order,
          mysql_tpcch_orderline
      WHERE
          c_state LIKE 'A%'
          AND c_id = o_c_id
          AND c_w_id = o_w_id
          AND c_d_id = o_d_id
          AND no_w_id = o_w_id
          AND no_d_id = o_d_id
          AND no_o_id = o_id
          AND ol_w_id = o_w_id
          AND ol_d_id = o_d_id
          AND ol_o_id = o_id
          AND o_entry_d > TIMESTAMP '2007-01-02 00:00:00.000000'
      GROUP BY ol_o_id, ol_w_id, ol_d_id, o_entry_d
      ORDER BY revenue DESC, o_entry_d
