A `materialized` Grafana dashboard
==================================

This directory contains the implementation of a "dashboard in a box", a Docker image that
contains both Prometheus and Grafana (and some other tools) so that folks can very
quickly introspect their materialized, before they're ready to necessarily spin up
production monitoring pointing at materialized.

User documentation is at https://materialize.com/docs/monitoring/ (or
[doc/user/content/monitoring/_index.md][doc] locally).


## Updating the dashboard

The source of truth for this dashboard is http://grafana.mz/d/materialize-overview ,
which we keep up to date as we run load tests and discover better ways to monitor
ourselves.

If you want to modify the dashboard that we ship to users, you should instead modify the
"Materialized Overview" dashboard in grafana.mz, and save it, keeping it canonical for
ourselves.

Before releases, or whenever we'd like to update the dashboard we ship to users, we sync
the dashboard from grafana.mz to this directory, using the following procedure:

* downloading the json model from http://grafana.mz/d/materialize-overview/materialize-overview-load-tests?editview=dashboard_json
  into a file. The rest of this guide will assume you used `/tmp/dashboard.json`
* running the `bin/dashboard-clean` script on that downloaded json to overwrite the
  conf file. Execute this from the root of the repo:
  ```console
  $ bin/dashboard-clean /tmp/dashboard.json > misc/monitoring/dashboard/conf/grafana/dashboards/overview.json
  ```
* building the dashboard locally `mzimage build dashboard`
* running the dashboard inside a demo: `mzconduct run billing -w load-test`
* opening the dashboard and editing it to remove some _more_ of our cruft:
  ```console
  $ mzconduct web billing dashboard
  ```
  specifically, remove the "Meta" panel and make the "Materialize Build
  Info" panel wide enough to look reasonable.
* copying the json model into `/tmp/dashboard.json` again
* running the `bin/dashboard-clean` comamnd from above, again
* Run `mzimage build dashboard` and restart the load test to verify that
  the changes look reasonable on a reload:
  ```console
  $ mzconduct down billing && mzimage build dashboard && mzconduct run billing -w load-test
  ```

... that's all.

[doc]: ../../../doc/user/content/monitoring/_index.md

## Updating the SQL collectors

We capture additional metrics from the materialized logging views using the collectors
defined in [`conf/prometheus-sql-exporter/mz/arrangement.collector.yml`][coll].

When you those files and commit them the metrics will populate on several schedules, in
decreasing speed:

* When you run any mzcompose file (via mzconduct or mzcompose), the dashboard *should*
  automatically pick up all metrics generated by the arrangement collector, but sometimes
  you have to run `mzconduct nuke` to ensure that the dashboard is not cached
  incorrectly.

  This is the best way to test your changes locally.

* Once the change has been merged you can trigger a load test specifying the git ref of
  the commit that you introduced or merged the arrangements collector change in.

  This allows you to update the dashboard on grafana.mz while the code is still fresh in
  your mind.

* In grafana.mz the metrics will be available on the the next nightly, which means you
  can start modifying the dashboard the next day.


[coll]: conf/prometheus-sql-exporter/mz/arrangement.collector.yml
