# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

# Tests to exercise compare_and_downgrade_since on critical SinceHandles.

# The shard global since == 0 initially
shard-desc
----
since=[0] upper=[0]

# A newly registered handle gets that since.
register-critical-reader reader_id=c00000000-0000-0000-0000-000000000000
----
v2 [0]

# Successful downgrade
compare-and-downgrade-since expect_token=0 expect_since=(0) token=0 since=(2) reader_id=c00000000-0000-0000-0000-000000000000
----
v3 0 [2]

shard-desc
----
since=[2] upper=[0]

# Expected since doesn't match
compare-and-downgrade-since expect_token=0 expect_since=(3) token=0 since=(4) reader_id=c00000000-0000-0000-0000-000000000000
----
error: mismatch: token=0, since=Since(Antichain { elements: [2] })

# Expected token doesn't match
compare-and-downgrade-since expect_token=100 expect_since=(2) token=0 since=(4) reader_id=c00000000-0000-0000-0000-000000000000
----
error: mismatch: token=0, since=Since(Antichain { elements: [2] })

# Create a second reader. This gets the current since for a capability.
register-critical-reader reader_id=c11111111-1111-1111-1111-111111111111
----
v6 [2]

# Shard since doesn't change until the meet (min) of all handle sinces changes.
compare-and-downgrade-since expect_token=0 expect_since=(2) token=11 since=(3) reader_id=c11111111-1111-1111-1111-111111111111
----
v7 11 [3]

shard-desc
----
since=[2] upper=[0]

# Shard since == 3 when all handle have since >= 3. NB: expected matches this
# handle's since capability, not the shard's global since
compare-and-downgrade-since expect_token=0 expect_since=(2) token=0 since=(5) reader_id=c00000000-0000-0000-0000-000000000000
----
v8 0 [5]

shard-desc
----
since=[3] upper=[0]

# Shard since unaffected by handle with since > shard since expiring.
expire-critical-reader reader_id=c00000000-0000-0000-0000-000000000000
----
v9 ok

shard-desc
----
since=[3] upper=[0]

# Create a third handle. It gets the current since of 3.
register-critical-reader reader_id=c22222222-2222-2222-2222-222222222222
----
v10 [3]

# Shard since doesn't change until the meet (min) of all handle sinces changes.
compare-and-downgrade-since expect_token=0 expect_since=(3) token=22 since=(10) reader_id=c22222222-2222-2222-2222-222222222222
----
v11 22 [10]

shard-desc
----
since=[3] upper=[0]

# Shard since advances when handle with the minimal since expires.
#
# TODO: expiry temporarily doesn't advance since until we have #15511.
# Switch this assertion back when we re-enable this.
expire-critical-reader reader_id=c11111111-1111-1111-1111-111111111111
----
v12 ok

shard-desc
----
since=[3] upper=[0]

# Shard since unaffected when all handle are expired.
#
# TODO: expiry temporarily doesn't advance since until we have #15511.
# Switch this assertion back when we re-enable this.
expire-critical-reader reader_id=c22222222-2222-2222-2222-222222222222
----
v13 ok

shard-desc
----
since=[3] upper=[0]
