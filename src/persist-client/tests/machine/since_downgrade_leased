# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

# Tests to exercise downgrade_since on leased ReadHandles.

# The shard global since == 0 initially
shard-desc
----
since=[0] upper=[0]

# We'll use a critical reader to determine the since of newly-minted leases
register-critical-reader reader_id=c22222222-2222-2222-2222-222222222222
----
v2 [0]

# A newly registered reader gets that since.
register-leased-reader reader_id=r00000000-0000-0000-0000-000000000000
----
v3 [0]

# Greater
downgrade-since since=(2) reader_id=r00000000-0000-0000-0000-000000000000
----
v4 [2]

shard-desc
----
since=[0] upper=[0]

# Equal (no-op)
downgrade-since since=(2) reader_id=r00000000-0000-0000-0000-000000000000
----
v5 [2]

# Less (no-op)
downgrade-since since=(1) reader_id=r00000000-0000-0000-0000-000000000000
----
v6 [2]

# Create a second reader. This gets the current critical since for a capability.
compare-and-downgrade-since since=1 expect_opaque=0 opaque=1 reader_id=c22222222-2222-2222-2222-222222222222
----
v7 1 [1]

register-leased-reader reader_id=r11111111-1111-1111-1111-111111111111
----
v8 [1]

# Shard since doesn't change until the meet (min) of all reader sinces changes.
downgrade-since since=(3) reader_id=r11111111-1111-1111-1111-111111111111
----
v9 [3]

shard-desc
----
since=[1] upper=[0]

# Shard since == 3 when all readers have since >= 3.
downgrade-since since=(5) reader_id=r00000000-0000-0000-0000-000000000000
----
v10 [5]

shard-desc
----
since=[1] upper=[0]

compare-and-downgrade-since since=3 expect_opaque=1 opaque=2 reader_id=c22222222-2222-2222-2222-222222222222
----
v11 2 [3]

shard-desc
----
since=[3] upper=[0]

# Shard since unaffected readers with since > shard since expiring.
expire-leased-reader reader_id=r00000000-0000-0000-0000-000000000000
----
v12 ok

shard-desc
----
since=[3] upper=[0]

# Create a third reader. It gets the current since of 3.
register-leased-reader reader_id=r22222222-2222-2222-2222-222222222222
----
v13 [3]

# Shard since doesn't change until the meet (min) of all reader sinces changes.
downgrade-since since=(10) reader_id=r22222222-2222-2222-2222-222222222222
----
v14 [10]

shard-desc
----
since=[3] upper=[0]

# Shard since advances when reader with the minimal since expires.
#
# TODO(#22789): expiry temporarily doesn't advance since
# Switch this assertion back when we re-enable this.
expire-leased-reader reader_id=r11111111-1111-1111-1111-111111111111
----
v15 ok

shard-desc
----
since=[3] upper=[0]

# Shard since unaffected when all readers are expired.
#
# TODO(#22789): expiry temporarily doesn't advance since
# Switch this assertion back when we re-enable this.
expire-leased-reader reader_id=r22222222-2222-2222-2222-222222222222
----
v16 ok

shard-desc
----
since=[3] upper=[0]
