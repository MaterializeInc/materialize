# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

cat
(defsource x [int64 int64])
(defsource y [int64 int64])
----
ok

# simple positive test
# (select * from x) except all (select * from x where a < 7)
build apply=ThresholdElision
(threshold
  (union [
    (get x)
    (negate
      (filter (get x) [(call_binary lt #0 (7 Int64))]))]))
----
error: Object spec [Ident { sym: get, span: bytes(10269..10272) }, Ident { sym: x, span: bytes(10273..10274) }] (type Vec<MirScalarExpr>) has unsupported delimiter Parenthesis

# simple positive test
# (select * from x) except all (select * from x where a < 7)
build apply=ThresholdElision
(threshold
  (union [
    (get x)
    (negate
      (filter (get x) [(call_binary lt #0 (7 Int64))]))]))
----
error: Object spec [Ident { sym: get, span: bytes(10375..10378) }, Ident { sym: x, span: bytes(10379..10380) }] (type Vec<MirScalarExpr>) has unsupported delimiter Parenthesis


# simple negative test: EXCEPT ALL
# (select * from x) except all (select * from y where a < 7)
build apply=ThresholdElision
(threshold
  (union [
    (get x)
    (negate
      (filter (get y) [(call_binary lt #0 (7 Int64))]))]))
----
error: Object spec [Ident { sym: get, span: bytes(10481..10484) }, Ident { sym: y, span: bytes(10485..10486) }] (type Vec<MirScalarExpr>) has unsupported delimiter Parenthesis

# simple positive test: EXCEPT
# (select * from x) except (select * from x where a < 7)
build apply=ThresholdElision
(threshold
  (union [
    (reduce (get x) [#1 #2] [])
    (negate
      (reduce (filter (get x) [(call_binary lt #0 (7 Int64))]) [#1 #2] [])) ]))
----
error: Object spec [Ident { sym: get, span: bytes(10561..10564) }, Ident { sym: x, span: bytes(10565..10566) }] (type Vec<MirScalarExpr>) has unsupported delimiter Parenthesis

# simple positive test: EXCEPT where the lhs has a Negate
# with r as (select * from x except select * from x where a < 7)
# select * from r except all select * from r where a > 9;
build apply=ThresholdElision
(let z
    (threshold
      (union [
        (get x)
        (negate
          (filter (get x) [(call_binary lt #0 (7 Int64))])) ]))
    (threshold
      (union [
        (get z)
        (negate
          (filter (get z) [(call_binary gt #0 (9 Int64))])) ])))
----
error: Object spec [Ident { sym: get, span: bytes(10761..10764) }, Ident { sym: x, span: bytes(10765..10766) }] (type Vec<MirScalarExpr>) has unsupported delimiter Parenthesis

# simple negative test: EXCEPT
# (select * from x) except (select * from y where a > 7)
build apply=ThresholdElision
(threshold
  (union [
    (reduce (get x) [#1 #2] [])
    (negate
      (reduce (filter (get y) [(call_binary lt #0 (7 Int64))]) [#1 #2] [])) ]))
----
error: Object spec [Ident { sym: get, span: bytes(10969..10972) }, Ident { sym: x, span: bytes(10973..10974) }] (type Vec<MirScalarExpr>) has unsupported delimiter Parenthesis

# positive test: EXCEPT where the lhs has a Negate
# with r as (select * from x except select * from x where a < 7)
# select * from r except all select * from r where a > 9;
build apply=ThresholdElision
(let z
    (threshold
      (union [
        (get x)
        (negate
          (filter (get x) [(call_binary lt #0 (7 Int64))])) ]))
    (threshold
      (union [
        (get z)
        (negate
          (filter (get z) [(call_binary gt #0 (9 Int64))])) ])))
----
error: Object spec [Ident { sym: get, span: bytes(11169..11172) }, Ident { sym: x, span: bytes(11173..11174) }] (type Vec<MirScalarExpr>) has unsupported delimiter Parenthesis
