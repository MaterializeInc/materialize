# Copyright 2019 Materialize, Inc. All rights reserved.
#
# This file is part of Materialize. Materialize may not be used or
# distributed without the express permission of Materialize, Inc.

mode cockroach

statement ok
CREATE TABLE t (a int, b int)

statement ok
INSERT INTO t (a, b) VALUES (1, 1), (1, 2), (2, 3), (3, 1)

statement error aggregate functions are not allowed in WHERE clause
SELECT a FROM t WHERE sum(b) = 3 GROUP BY a;

query III colnames
SELECT 1 AS literal, sum(a) as sum_a, sum(b) FROM t
----
literal  sum_a  sum
1        7      7

query I rowsort
SELECT a FROM t GROUP BY a HAVING sum(b) = 3;
----
1
2

query I rowsort
SELECT a+1 FROM t GROUP BY a+1 HAVING sum(b) = 3;
----
2
3

query TTT colnames
SHOW COLUMNS FROM t
----
Field  Nullable  Type
 a     YES       int8
 b     YES       int8

# avg on an integer column should return a decimal with the default decimal
# division scale increase.

query R
SELECT avg(a) FROM t
----
1.750000

# But avg on a float column should return a float.

statement ok
CREATE TABLE t2 (a float)

statement ok
INSERT INTO t2 VALUES (1.0), (1.0), (2.0), (3.0)

query R
SELECT avg(a) FROM t2
----
1.75

# avg of an explicit NULL should return NULL.

query R
SELECT avg(NULL)
----
NULL
