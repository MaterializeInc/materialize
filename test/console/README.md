# Introduction

This directory contains mzcompose workflows for testing the Materialize console
against different Materialize versions.

## Quick Start

```bash
# Start services with the default (current source) build
./mzcompose run default

# Run console SQL tests (from console repo)
cd ~/dev/console && yarn test:sql

# Stop services when done
cd ~/dev/materialize/test/console && ./mzcompose down -v
```

## Available Workflows

### `default` - Start Services (Current Source)

Starts Materialize (current source build) with Redpanda, Postgres, MySQL, and SQL Server.

```bash
./mzcompose run default
```

### `list-versions` - Show Version Matrix

Outputs a JSON object with the versions to test against. This is useful for CI/CD
pipelines that need to determine which versions to test.

```bash
./mzcompose run list-versions
```

**Example output:**
```json
{
  "latest": "v26.1.1",
  "previous": "v26.0.0",
  "older": "v0.164.2",
  "self-managed": "v26.1.1"
}
```

**Version meanings:**
- `latest`: Most recent minor version
- `previous`: One minor version back
- `older`: Two minor versions back
- `self-managed`: Latest self-managed version from Helm chart

### `start-version` - Start Services with Specific Version

Starts services with a specific Materialize version. Use this for testing console
compatibility across different Materialize releases.

```bash
# Using version aliases
./mzcompose run start-version latest
./mzcompose run start-version previous
./mzcompose run start-version older
./mzcompose run start-version self-managed

# Using a direct version tag
./mzcompose run start-version v26.1.1
```

After starting, run tests from the console repo:
```bash
cd ~/dev/console && yarn test:sql
```

Then stop services:
```bash
./mzcompose down -v
```

## Multi-Version Testing (Local)

To test against all versions locally:

```bash
# 1. See available versions
./mzcompose run list-versions

# 2. Test each version
for version in latest previous older self-managed; do
  echo "Testing $version..."
  ./mzcompose down -v
  ./mzcompose run start-version $version
  cd ~/dev/console && yarn test:sql
  cd ~/dev/materialize/test/console
done

./mzcompose down -v
```

## GitHub Actions Integration

For CI/CD in the console repository, the typical flow is:

1. Checkout the materialize repo
2. Run `./mzcompose run list-versions` to get the version matrix as JSON
3. Parse the JSON to create a GitHub Actions matrix strategy
4. For each version in the matrix:
   - Run `./mzcompose run start-version <version-alias>`
   - Run `yarn test:sql`
   - Run `./mzcompose down -v`

## How Version Selection Works

The version matrix is generated by `get_published_minor_mz_versions()` which:

1. Gets all Materialize versions from git tags
2. Filters to the latest patch for each minor version (e.g., v26.1.1, not v26.1.0)
3. Verifies Docker images exist for each version
4. Returns the 5 most recent minor versions

For self-managed, it fetches from the Helm chart at
`https://materializeinc.github.io/materialize/index.yaml` and returns the latest version.
