# Copyright Materialize, Inc. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

version: '3.8'

mzworkflows:
  pg-cdc:
    steps:
      - step: workflow
        workflow: start-deps

#
# Prime the Postgres database with interesting data
#

      - step: run-postgres
        queries:
          - ALTER USER postgres WITH replication;
          - DROP PUBLICATION IF EXISTS mz_source;
          - DROP SCHEMA IF EXISTS public CASCADE;
          - CREATE SCHEMA public;

          - CREATE TABLE pk_table (pk INTEGER PRIMARY KEY, f2 TEXT);
          - INSERT INTO pk_table VALUES (1, 'one');
          - ALTER TABLE pk_table REPLICA IDENTITY FULL;
          - INSERT INTO pk_table VALUES (2, 'two');

          - CREATE PUBLICATION mz_source FOR ALL TABLES;
          - INSERT INTO pk_table VALUES (3, 'three');

          - CREATE TABLE nonpk_table (f1 INTEGER, f2 INTEGER);
          - INSERT INTO nonpk_table VALUES (1, 1), (1, 1);
          - ALTER TABLE nonpk_table REPLICA IDENTITY FULL;
          - INSERT INTO nonpk_table VALUES (2, 2), (2, 2);

          - CREATE TABLE types_table (date_col DATE, time_col TIME, timestamp_col TIMESTAMP, uuid_col UUID, double_col DOUBLE PRECISION);
          - INSERT INTO types_table VALUES ('2011-11-11', '11:11:11', '2011-11-11 11:11:11', 'A0EEBC99-9C0B-4EF8-BB6D-6BB9BD380A11', 1234.56768);
          - ALTER TABLE types_table REPLICA IDENTITY FULL;

          - CREATE TABLE large_text (f1 TEXT);
          - INSERT INTO large_text VALUES (REPEAT('x', 16 * 1024 * 1024));
          - ALTER TABLE large_text REPLICA IDENTITY FULL;

          - CREATE TABLE trailing_space_pk (f1 TEXT PRIMARY KEY);
          - INSERT INTO trailing_space_pk VALUES ('abc   ');
          - ALTER TABLE trailing_space_pk REPLICA IDENTITY FULL;

          - CREATE TABLE trailing_space_nopk (f1 TEXT);
          - INSERT INTO trailing_space_nopk VALUES ('abc   ');
          - ALTER TABLE trailing_space_nopk REPLICA IDENTITY FULL;

          - CREATE TABLE multipart_pk(f1 INTEGER, f2 TEXT, f3 TEXT, PRIMARY KEY (f1, f2));
          - INSERT INTO multipart_pk VALUES (1, 'abc', 'xyz');
          - ALTER TABLE multipart_pk REPLICA IDENTITY FULL;

          - CREATE TABLE nulls_table (f1 TEXT, f2 INTEGER);
          - INSERT INTO nulls_table VALUES (NULL, NULL);
          - ALTER TABLE nulls_table REPLICA IDENTITY FULL;

          - CREATE TABLE utf8_table (f1 TEXT PRIMARY KEY, f2 TEXT);
          - INSERT INTO utf8_table VALUES ('това е текст', 'това ''е'' "текст"');
          - ALTER TABLE utf8_table REPLICA IDENTITY FULL;

      - step: run
        service: testdrive-svc
        command: pg-cdc-establish.td

      - step: run-postgres
        queries:
          - INSERT INTO pk_table VALUES (4, 'four')
          - INSERT INTO pk_table VALUES (5, 'five')
          - DELETE FROM pk_table WHERE pk = 1;
          - UPDATE pk_table SET f2 = 'two_two' WHERE pk = 2;
          - UPDATE pk_table SET pk = pk + 10 WHERE pk BETWEEN 3 AND 4

          - INSERT INTO nonpk_table VALUES (3, 3), (3, 3);
          - DELETE FROM nonpk_table WHERE ctid = '(0,1)';
          - UPDATE nonpk_table SET f1 = f1 + 10 WHERE ctid = '(0,2)';
          - UPDATE nonpk_table SET f1 = f1 + 100 WHERE f1 = 3;

          - INSERT INTO types_table VALUES ('2011-11-11', '11:11:11', '2011-11-11 11:11:11', 'A0EEBC99-9C0B-4EF8-BB6D-6BB9BD380A11', 1234.56768);

          - INSERT INTO large_text VALUES (REPEAT('x', 16 * 1024 * 1024));

          - INSERT INTO trailing_space_pk VALUES ('klm   ');
          - UPDATE trailing_space_pk SET f1 = 'xyz   ' WHERE f1 = 'klm   ';
          - DELETE FROM trailing_space_pk WHERE f1 = 'abc   ';

          - INSERT INTO trailing_space_nopk VALUES ('klm   ');
          - UPDATE trailing_space_nopk SET f1 = 'xyz   ' WHERE f1 = 'klm   ';
          - DELETE FROM trailing_space_nopk WHERE f1 = 'abc   ';

          - INSERT INTO multipart_pk VALUES (2, 'klm', 'xyz');
          - DELETE FROM multipart_pk WHERE f1 = 1;

          - UPDATE nulls_table SET f2 = 3 WHERE f2 IS NULL;
          - INSERT INTO nulls_table VALUES (NULL, 1), (NULL, 2);
          - UPDATE nulls_table SET f2 = NULL WHERE f2 = 2;

          - INSERT INTO utf8_table VALUES ('това е текст 2', 'това ''е'' "текст" 2');
          - UPDATE utf8_table SET f1 = f1 || f1 , f2 = f2 || f2;

      - step: run
        service: testdrive-svc
        command: --no-reset pg-cdc-inprogress.td

      - step: run-postgres
        queries:
            - DELETE FROM pk_table;
            - DELETE FROM nonpk_table;
            - DELETE FROM large_text;
            - DELETE FROM trailing_space_pk;
            - DELETE FROM trailing_space_nopk;
            - DELETE FROM multipart_pk;
            - DELETE FROM nulls_table;
            - DELETE FROM utf8_table;

      - step: run
        service: testdrive-svc
        command: --no-reset pg-cdc-emptied.td

  start-deps:
    steps:
      - step: start-services
        services: [postgres, materialized]

      - step: wait-for-postgres

      - step: wait-for-mz

services:
  testdrive-svc:
    mzbuild: testdrive
    entrypoint:
      - bash
      - -c
      - >-
        testdrive
        --materialized-url=postgres://materialize@materialized:6875
        $$*
      - bash
    volumes:
    - .:/workdir
    depends_on: [materialized, postgres]

  materialized:
    mzbuild: materialized
    command: >-
      --experimental
      --workers 1
      --disable-telemetry
    ports:
      - 6875
    environment:
    - MZ_DEV=1
    - MZ_LOG

  postgres:
    image: postgres:11.4
    ports:
      - 5432
    command: postgres -c wal_level=logical
