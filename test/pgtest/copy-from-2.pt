send
Query {"query": "DROP TABLE IF EXISTS t"}
----

until ignore=NoticeResponse
ReadyForQuery
----
CommandComplete {"tag":"DROP TABLE"}
ReadyForQuery {"status":"I"}

send
Query {"query": "CREATE TABLE t (i INT8, t TEXT)"}
----

until
ReadyForQuery
----
CommandComplete {"tag":"CREATE TABLE"}
ReadyForQuery {"status":"I"}

# COPY with both empty string and \N for NULL.
send
Query {"query": "COPY t FROM STDIN"}
CopyData "1\tblah\n"
CopyData "2\t\n"
CopyData "3\t\\N\n"
CopyData "\\.\n"
CopyDone
Query {"query": "SELECT * FROM t ORDER BY i"}
----

until ignore=RowDescription
ReadyForQuery
ReadyForQuery
----
CopyIn {"format":"text","column_formats":["text","text"]}
CommandComplete {"tag":"COPY 3"}
ReadyForQuery {"status":"I"}
RowDescription {"fields":[{"name":"i"},{"name":"t"}]}
DataRow {"fields":["1","blah"]}
DataRow {"fields":["2",""]}
DataRow {"fields":["3","NULL"]}
CommandComplete {"tag":"SELECT 3"}
ReadyForQuery {"status":"I"}

# Wrong number of columns.
send
Query {"query": "COPY t FROM STDIN"}
CopyData "1\n"
CopyData "\\.\n"
CopyDone
----

until
ErrorResponse
ReadyForQuery
----
CopyIn {"format":"text","column_formats":["text","text"]}
ErrorResponse {"fields":[{"typ":"C","value":"22P04"},{"typ":"M","value":"missing data for column \"t\""}]}
ReadyForQuery {"status":"I"}

# Verify that only one COPY can run at once.
send
Query {"query": "COPY t FROM STDIN"}
Query {"query": "COPY t FROM STDIN"}
----

until
ErrorResponse
ReadyForQuery
----
CopyIn {"format":"text","column_formats":["text","text"]}
ErrorResponse {"fields":[{"typ":"C","value":"08P01"},{"typ":"M","value":"unexpected message type 0x51 during COPY from stdin"}]}
ReadyForQuery {"status":"I"}

# Verify that after a COPY has started another statement cannot run.
send
Query {"query": "COPY t FROM STDIN"}
Query {"query": "SELECT 2"}
----

until ignore=RowDescription
ErrorResponse
ReadyForQuery
----
CopyIn {"format":"text","column_formats":["text","text"]}
ErrorResponse {"fields":[{"typ":"C","value":"08P01"},{"typ":"M","value":"unexpected message type 0x51 during COPY from stdin"}]}
ReadyForQuery {"status":"I"}

send
Query {"query": "DROP TABLE t"}
Query {"query": "CREATE TABLE t (i INT8, t TEXT)"}
Query {"query": "COPY t FROM STDIN"}
CopyData "1\tblah\n"
CopyData "\\.\n"
CopyDone
Query {"query": "SELECT * FROM t ORDER BY i"}
----

until ignore=RowDescription
ReadyForQuery
ReadyForQuery
ReadyForQuery
ReadyForQuery
----
CommandComplete {"tag":"DROP TABLE"}
ReadyForQuery {"status":"I"}
CommandComplete {"tag":"CREATE TABLE"}
ReadyForQuery {"status":"I"}
CopyIn {"format":"text","column_formats":["text","text"]}
CommandComplete {"tag":"COPY 1"}
ReadyForQuery {"status":"I"}
RowDescription {"fields":[{"name":"i"},{"name":"t"}]}
DataRow {"fields":["1","blah"]}
CommandComplete {"tag":"SELECT 1"}
ReadyForQuery {"status":"I"}

send
Query {"query": "DROP TABLE t"}
Query {"query": "CREATE TABLE t (i INT8, t TEXT)"}
Query {"query": "COPY t FROM STDIN DELIMITER ','"}
CopyData "1,blah\n"
CopyData "2,\\N\n"
CopyData "\\.\n"
CopyDone
Query {"query": "SELECT * FROM t ORDER BY i"}
----

until ignore=RowDescription
ReadyForQuery
ReadyForQuery
ReadyForQuery
ReadyForQuery
----
CommandComplete {"tag":"DROP TABLE"}
ReadyForQuery {"status":"I"}
CommandComplete {"tag":"CREATE TABLE"}
ReadyForQuery {"status":"I"}
CopyIn {"format":"text","column_formats":["text","text"]}
CommandComplete {"tag":"COPY 2"}
ReadyForQuery {"status":"I"}
RowDescription {"fields":[{"name":"i"},{"name":"t"}]}
DataRow {"fields":["1","blah"]}
DataRow {"fields":["2","NULL"]}
CommandComplete {"tag":"SELECT 2"}
ReadyForQuery {"status":"I"}

send
Query {"query": "DROP TABLE t"}
Query {"query": "CREATE TABLE t (i INT8, t TEXT)"}
Query {"query": "COPY t FROM STDIN NULL 'NS'"}
CopyData "1\tblah\n"
CopyData "2\t\\N\n"
CopyData "3\tNS\n"
CopyData "\\.\n"
CopyDone
Query {"query": "SELECT * FROM t ORDER BY i"}
----

until ignore=RowDescription
ReadyForQuery
ReadyForQuery
ReadyForQuery
ReadyForQuery
----
CommandComplete {"tag":"DROP TABLE"}
ReadyForQuery {"status":"I"}
CommandComplete {"tag":"CREATE TABLE"}
ReadyForQuery {"status":"I"}
CopyIn {"format":"text","column_formats":["text","text"]}
CommandComplete {"tag":"COPY 3"}
ReadyForQuery {"status":"I"}
RowDescription {"fields":[{"name":"i"},{"name":"t"}]}
DataRow {"fields":["1","blah"]}
DataRow {"fields":["2","N"]}
DataRow {"fields":["3","NULL"]}
CommandComplete {"tag":"SELECT 3"}
ReadyForQuery {"status":"I"}

send
Query {"query": "COPY t FROM STDIN"}
CopyData "1\n"
CopyData "\\.\n"
CopyDone
----

until ignore=RowDescription
ErrorResponse
ReadyForQuery
----
CopyIn {"format":"text","column_formats":["text","text"]}
ErrorResponse {"fields":[{"typ":"C","value":"22P04"},{"typ":"M","value":"missing data for column \"t\""}]}
ReadyForQuery {"status":"I"}

send
Query {"query": "DROP TABLE t"}
Query {"query": "CREATE TABLE t (i INT8, t TEXT)"}
Query {"query": "COPY t FROM STDIN CSV"}
CopyData "1,blah\n"
CopyData "2,\n"
CopyData "\\.\n"
CopyDone
Query {"query": "SELECT * FROM t ORDER BY i"}
----

until ignore=RowDescription
ReadyForQuery
ReadyForQuery
ReadyForQuery
ReadyForQuery
----
CommandComplete {"tag":"DROP TABLE"}
ReadyForQuery {"status":"I"}
CommandComplete {"tag":"CREATE TABLE"}
ReadyForQuery {"status":"I"}
CopyIn {"format":"text","column_formats":["text","text"]}
CommandComplete {"tag":"COPY 2"}
ReadyForQuery {"status":"I"}
RowDescription {"fields":[{"name":"i"},{"name":"t"}]}
DataRow {"fields":["1","blah"]}
DataRow {"fields":["2","NULL"]}
CommandComplete {"tag":"SELECT 2"}
ReadyForQuery {"status":"I"}

send
Query {"query": "DROP TABLE t"}
Query {"query": "CREATE TABLE t (i INT8, t TEXT)"}
Query {"query": "COPY t FROM STDIN CSV NULL 'NS' DELIMITER '|'"}
CopyData "1|blah\n"
CopyData "2|NS\n"
CopyData "3|\n"
CopyData "\\.\n"
CopyDone
Query {"query": "SELECT * FROM t ORDER BY i"}
----

until ignore=RowDescription
ReadyForQuery
ReadyForQuery
ReadyForQuery
ReadyForQuery
----
CommandComplete {"tag":"DROP TABLE"}
ReadyForQuery {"status":"I"}
CommandComplete {"tag":"CREATE TABLE"}
ReadyForQuery {"status":"I"}
CopyIn {"format":"text","column_formats":["text","text"]}
CommandComplete {"tag":"COPY 3"}
ReadyForQuery {"status":"I"}
RowDescription {"fields":[{"name":"i"},{"name":"t"}]}
DataRow {"fields":["1","blah"]}
DataRow {"fields":["2","NULL"]}
DataRow {"fields":["3",""]}
CommandComplete {"tag":"SELECT 3"}
ReadyForQuery {"status":"I"}

send
Query {"query": "COPY t FROM STDIN CSV"}
CopyData "1\n"
CopyData "\\.\n"
CopyDone
----

until ignore=RowDescription
ErrorResponse
ReadyForQuery
----
CopyIn {"format":"text","column_formats":["text","text"]}
ErrorResponse {"fields":[{"typ":"C","value":"22P04"},{"typ":"M","value":"missing data for column \"t\""}]}
ReadyForQuery {"status":"I"}
