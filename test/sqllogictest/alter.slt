# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

mode cockroach

simple conn=mz_system,user=mz_system
ALTER SYSTEM SET enable_connection_validation_syntax TO true;
----
COMPLETE 0

simple conn=mz_system,user=mz_system
ALTER SYSTEM SET enable_rbac_checks TO false;
----
COMPLETE 0

query error system schema 'mz_catalog' cannot be modified
ALTER TABLE mz_tables RENAME TO foo;

query error system schema 'mz_internal' cannot be modified
ALTER SOURCE mz_internal.mz_storage_shards RENAME TO foo;

query error cannot ALTER this type of source
ALTER SOURCE mz_internal.mz_storage_shards RESET (size);

statement ok
CREATE CONNECTION c TO KAFKA (BROKER 'localhost:9092') WITH (VALIDATE = false);

query TT
SHOW CONNECTIONS
----
c   kafka

statement ok
ALTER CONNECTION c RENAME TO d;

query TT
SHOW CONNECTIONS
----
d   kafka

statement ok
CREATE CLUSTER other_cluster SIZE '1', REPLICATION FACTOR 0

query error db error: ERROR: ALTER \.\.\. SET CLUSTER syntax is not supported
ALTER MATERIALIZED VIEW does_not_exist SET CLUSTER default

query error db error: ERROR: ALTER \.\.\. SET CLUSTER syntax is not supported
ALTER SOURCE does_not_exist SET CLUSTER default

query error db error: ERROR: ALTER \.\.\. SET CLUSTER syntax is not supported
ALTER SINK does_not_exist SET CLUSTER default

simple conn=mz_system,user=mz_system
ALTER SYSTEM SET enable_alter_set_cluster = on;
----
COMPLETE 0

statement ok
CREATE VIEW v AS SELECT 1

statement ok
CREATE MATERIALIZED VIEW mv AS SELECT 1

statement ok
ALTER MATERIALIZED VIEW mv SET CLUSTER default

query error db error: ERROR: unknown cluster 'does_not_exist'
ALTER MATERIALIZED VIEW mv SET CLUSTER does_not_exist

statement ok
ALTER MATERIALIZED VIEW mv SET CLUSTER other_cluster

query error db error: ERROR: ALTER VIEW SET CLUSTER is not supported, for more information consult the documentation at https://materialize\.com/docs/sql/alter\-set\-cluster/
ALTER VIEW mv SET CLUSTER default

query error db error: ERROR: Cannot modify view as MATERIALIZED VIEW
ALTER MATERIALIZED VIEW v SET CLUSTER default

query error db error: ERROR: ALTER SINK SET CLUSTER not yet supported, see https://github\.com/MaterializeInc/materialize/issues/20841 for more details
ALTER SINK v SET CLUSTER default

statement ok
CREATE MATERIALIZED VIEW mv_const AS SELECT 1

query I
SELECT * FROM mv_const
----
1

statement ok
ALTER MATERIALIZED VIEW mv_const SET CLUSTER other_cluster

query I
SELECT * FROM mv_const
----
1

statement ok
ALTER MATERIALIZED VIEW mv_const SET CLUSTER default

query I
SELECT * FROM mv_const
----
1

statement ok
DROP MATERIALIZED VIEW mv_const

statement ok
CREATE CLUSTER c1 SIZE '1', REPLICATION FACTOR 3

statement ok
CREATE TABLE t1(a int)

statement ok
CREATE MATERIALIZED VIEW mv_t1 AS SELECT * from t1

statement ok
INSERT INTO t1 VALUES (1)

query I
SELECT a FROM mv_t1 ORDER BY a
----
1

statement ok
ALTER MATERIALIZED VIEW mv_t1 SET CLUSTER c1

statement ok
INSERT INTO t1 VALUES (2)

query I
SELECT a FROM mv_t1 ORDER BY a
----
1
2

statement ok
ALTER MATERIALIZED VIEW mv_t1 SET CLUSTER default

statement ok
INSERT INTO t1 VALUES (3)

query I
SELECT a FROM mv_t1 ORDER BY a
----
1
2
3

statement ok
ALTER MATERIALIZED VIEW mv_t1 SET CLUSTER c1

statement ok
ALTER MATERIALIZED VIEW mv_t1 SET CLUSTER default

statement ok
ALTER MATERIALIZED VIEW mv_t1 SET CLUSTER c1

statement ok
ALTER MATERIALIZED VIEW mv_t1 SET CLUSTER default

statement ok
ALTER MATERIALIZED VIEW mv_t1 SET CLUSTER c1

statement ok
ALTER MATERIALIZED VIEW mv_t1 SET CLUSTER default

statement ok
ALTER MATERIALIZED VIEW mv_t1 SET CLUSTER c1

statement ok
ALTER MATERIALIZED VIEW mv_t1 SET CLUSTER default

statement ok
INSERT INTO t1 VALUES (4)

statement ok
ALTER MATERIALIZED VIEW mv_t1 SET CLUSTER c1

statement ok
ALTER MATERIALIZED VIEW mv_t1 SET CLUSTER default

statement ok
ALTER MATERIALIZED VIEW mv_t1 SET CLUSTER c1

statement ok
ALTER MATERIALIZED VIEW mv_t1 SET CLUSTER default

statement ok
ALTER MATERIALIZED VIEW mv_t1 SET CLUSTER c1

statement ok
ALTER MATERIALIZED VIEW mv_t1 SET CLUSTER default

statement ok
ALTER MATERIALIZED VIEW mv_t1 SET CLUSTER c1

statement ok
ALTER MATERIALIZED VIEW mv_t1 SET CLUSTER default

statement ok
INSERT INTO t1 VALUES (5)

query I
SELECT a FROM mv_t1 ORDER BY a
----
1
2
3
4
5


statement ok
CREATE TABLE alter_mv_set_cluster_table (f1 INTEGER)

statement ok
CREATE CLUSTER alter_mv_set_cluster_cluster1 REPLICAS (replica1 (SIZE '1'));

statement ok
CREATE MATERIALIZED VIEW alter_mv_set_cluster_view1 AS SELECT f1 + 1 AS f1 FROM alter_mv_set_cluster_table;

statement ok
CREATE DEFAULT INDEX ON alter_mv_set_cluster_view1;

statement ok
INSERT INTO alter_mv_set_cluster_table VALUES (1);

statement ok
CREATE MATERIALIZED VIEW alter_mv_set_cluster_view2 AS SELECT f1 + 1 AS f1 FROM alter_mv_set_cluster_view1;

statement ok
CREATE DEFAULT INDEX ON alter_mv_set_cluster_view2;

statement ok
ALTER MATERIALIZED VIEW alter_mv_set_cluster_view1 SET CLUSTER alter_mv_set_cluster_cluster1;

statement ok
INSERT INTO alter_mv_set_cluster_table VALUES (2);

statement ok
CREATE CLUSTER alter_mv_set_cluster_cluster2 REPLICAS (replica1 (SIZE '1'));

statement ok
CREATE MATERIALIZED VIEW alter_mv_set_cluster_view3 AS SELECT f1 + 1 AS f1 FROM alter_mv_set_cluster_view2;

statement ok
CREATE DEFAULT INDEX ON alter_mv_set_cluster_view3;

statement ok
ALTER MATERIALIZED VIEW alter_mv_set_cluster_view1 SET CLUSTER alter_mv_set_cluster_cluster2;

statement ok
ALTER MATERIALIZED VIEW alter_mv_set_cluster_view2 SET CLUSTER alter_mv_set_cluster_cluster2;
