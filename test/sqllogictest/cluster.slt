# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

# Basic tests of the `CREATE CLUSTER` and `DROP CLUSTER` DDL statements.

mode cockroach

# Creating a cluster without any options does not work.
statement error one of REMOTE or SIZE must be specified
CREATE CLUSTER foo

# Creating a remote cluster works.
statement ok
CREATE CLUSTER foo REMOTE r1 ('localhost:1234')

statement error cluster 'foo' already exists
CREATE CLUSTER foo REMOTE r1 ('localhost:1234')

statement ok
CREATE CLUSTER bar REMOTE r1 ('localhost:1235'), REMOTE r2 ('localhost:1236')

query TT rowsort
SELECT * FROM mz_clusters
----
1 default
2 foo
3 bar

query T rowsort
SHOW CLUSTERS
----
bar
default
foo

query T rowsort
SHOW CLUSTERS LIKE 'd%'
----
default

# Test invalid option combinations.

statement error SIZE specified more than once
CREATE CLUSTER baz SIZE 'small', SIZE 'medium'

statement error only one of REMOTE or SIZE may be specified
CREATE CLUSTER baz REMOTE r1 ('localhost:1234'), SIZE 'small'

# Test `cluster` session variable.

query T
SHOW cluster
----
default

statement ok
SET cluster = 'bar'

query T
SHOW cluster
----
bar

statement ok
CREATE MATERIALIZED VIEW v AS SELECT 1

statement ok
SET cluster = 'default'

query T
SELECT * FROM v
----
1

query TTTTTTTT
SHOW INDEXES ON v IN CLUSTER bar;
----
bar v v_primary_idx 1 ?column? NULL false true

query T
SELECT
	mz_clusters.name
FROM
	mz_clusters JOIN mz_indexes ON mz_clusters.id = mz_indexes.cluster_id
WHERE
	mz_indexes.name = 'v_primary_idx';
----
bar

# Test invalid setting of `cluster`.

# It's okay to set the `cluster` variable to an invalid cluster.
statement ok
SET cluster = 'bad'

# But you can't do any reads on that cluster.
statement error unknown cluster 'bad'
SELECT * FROM v

# Nor can you create indexes on that cluster.
statement error unknown cluster 'bad'
CREATE MATERIALIZED VIEW v2 AS SELECT 1

# But you can create unmaterialized views on that cluster.
statement ok
CREATE VIEW unmat AS SELECT 1

# Test `CREATE INDEX ... IN CLUSTER`.
statement ok
SET cluster = 'default'

query T
SELECT name FROM mz_indexes WHERE name NOT LIKE 'mz_%';
----
v_primary_idx

statement ok
CREATE DEFAULT INDEX IN CLUSTER bar ON v

query TTTTTTTT
SHOW INDEXES ON v IN CLUSTER bar;
----
bar v v_primary_idx 1 ?column? NULL false true
bar v v_primary_idx1 1 ?column? NULL false true

statement error unknown cluster 'noexist'
CREATE DEFAULT INDEX IN CLUSTER noexist ON v

# Test invalid DROPs.

query T
SHOW cluster
----
default

statement error unknown cluster 'baz'
DROP CLUSTER baz

statement error cannot drop cluster with active indexes or sinks
DROP CLUSTER bar

query TTTTTTTT
SHOW INDEXES IN CLUSTER bar;
----
bar mz_arrangement_batches_internal mz_arrangement_batches_internal_3_primary_idx 1 operator NULL false true
bar mz_arrangement_batches_internal mz_arrangement_batches_internal_3_primary_idx 2 worker NULL false true
bar mz_arrangement_records_internal mz_arrangement_records_internal_3_primary_idx 1 operator NULL false true
bar mz_arrangement_records_internal mz_arrangement_records_internal_3_primary_idx 2 worker NULL false true
bar mz_arrangement_sharing_internal mz_arrangement_sharing_internal_3_primary_idx 1 operator NULL false true
bar mz_arrangement_sharing_internal mz_arrangement_sharing_internal_3_primary_idx 2 worker NULL false true
bar mz_dataflow_channels mz_dataflow_channels_3_primary_idx 1 id NULL false true
bar mz_dataflow_channels mz_dataflow_channels_3_primary_idx 2 worker NULL false true
bar mz_dataflow_operator_addresses mz_dataflow_operator_addresses_3_primary_idx 1 id NULL false true
bar mz_dataflow_operator_addresses mz_dataflow_operator_addresses_3_primary_idx 2 worker NULL false true
bar mz_dataflow_operator_reachability_internal mz_dataflow_operator_reachability_internal_3_primary_idx 1 address NULL false true
bar mz_dataflow_operator_reachability_internal mz_dataflow_operator_reachability_internal_3_primary_idx 2 port NULL false true
bar mz_dataflow_operator_reachability_internal mz_dataflow_operator_reachability_internal_3_primary_idx 3 worker NULL false true
bar mz_dataflow_operator_reachability_internal mz_dataflow_operator_reachability_internal_3_primary_idx 4 update_type NULL false true
bar mz_dataflow_operator_reachability_internal mz_dataflow_operator_reachability_internal_3_primary_idx 5 timestamp NULL true true
bar mz_dataflow_operators mz_dataflow_operators_3_primary_idx 1 id NULL false true
bar mz_dataflow_operators mz_dataflow_operators_3_primary_idx 2 worker NULL false true
bar mz_materialization_dependencies mz_materialization_dependencies_3_primary_idx 1 dataflow NULL false true
bar mz_materialization_dependencies mz_materialization_dependencies_3_primary_idx 2 source NULL false true
bar mz_materialization_dependencies mz_materialization_dependencies_3_primary_idx 3 worker NULL false true
bar mz_materializations mz_materializations_3_primary_idx 1 name NULL false true
bar mz_materializations mz_materializations_3_primary_idx 2 worker NULL false true
bar mz_message_counts_received_internal mz_message_counts_received_internal_3_primary_idx 1 channel NULL false true
bar mz_message_counts_received_internal mz_message_counts_received_internal_3_primary_idx 2 source_worker NULL false true
bar mz_message_counts_received_internal mz_message_counts_received_internal_3_primary_idx 3 target_worker NULL false true
bar mz_message_counts_sent_internal mz_message_counts_sent_internal_3_primary_idx 1 channel NULL false true
bar mz_message_counts_sent_internal mz_message_counts_sent_internal_3_primary_idx 2 source_worker NULL false true
bar mz_message_counts_sent_internal mz_message_counts_sent_internal_3_primary_idx 3 target_worker NULL false true
bar mz_peek_active mz_peek_active_3_primary_idx 1 id NULL false true
bar mz_peek_active mz_peek_active_3_primary_idx 2 worker NULL false true
bar mz_peek_durations mz_peek_durations_3_primary_idx 1 worker NULL false true
bar mz_peek_durations mz_peek_durations_3_primary_idx 2 duration_ns NULL false true
bar mz_scheduling_elapsed_internal mz_scheduling_elapsed_internal_3_primary_idx 1 id NULL false true
bar mz_scheduling_elapsed_internal mz_scheduling_elapsed_internal_3_primary_idx 2 worker NULL false true
bar mz_scheduling_histogram_internal mz_scheduling_histogram_internal_3_primary_idx 1 id NULL false true
bar mz_scheduling_histogram_internal mz_scheduling_histogram_internal_3_primary_idx 2 worker NULL false true
bar mz_scheduling_histogram_internal mz_scheduling_histogram_internal_3_primary_idx 3 duration_ns NULL false true
bar mz_scheduling_parks_internal mz_scheduling_parks_internal_3_primary_idx 1 worker NULL false true
bar mz_scheduling_parks_internal mz_scheduling_parks_internal_3_primary_idx 2 slept_for NULL false true
bar mz_scheduling_parks_internal mz_scheduling_parks_internal_3_primary_idx 3 requested NULL false true
bar mz_worker_materialization_frontiers mz_worker_materialization_frontiers_3_primary_idx 1 global_id NULL false true
bar mz_worker_materialization_frontiers mz_worker_materialization_frontiers_3_primary_idx 2 worker NULL false true
bar mz_worker_materialization_frontiers mz_worker_materialization_frontiers_3_primary_idx 3 time NULL false true
bar v v_primary_idx 1 ?column? NULL false true
bar v v_primary_idx1 1 ?column? NULL false true

statement ok
DROP INDEX v_primary_idx

statement ok
DROP INDEX v_primary_idx1

# Test valid DROPs

statement ok
DROP CLUSTER bar

statement ok
DROP CLUSTER foo

statement ok
CREATE CLUSTER baz REMOTE r1 ('localhost:1234')

statement ok
CREATE DEFAULT INDEX IN CLUSTER baz ON v

statement error cannot drop cluster with active indexes or sinks
DROP CLUSTER baz

statement ok
DROP CLUSTER baz CASCADE

query T
SELECT name FROM mz_indexes WHERE name NOT LIKE 'mz_%';
----

# Test that dropping a cluster and re-creating it with the same name is valid if introspection sources are enabled
statement ok
CREATE CLUSTER foo REMOTE r1 ('localhost:1234'), INTROSPECTION GRANULARITY '1s'

statement ok
DROP CLUSTER foo

statement ok
CREATE CLUSTER foo REMOTE r1 ('localhost:1234'), INTROSPECTION GRANULARITY '1s'

# Test that bad cluster sizes don't cause a crash

statement ok
DROP CLUSTER foo

statement error unknown cluster size
CREATE CLUSTER foo SIZE 'lol'

statement ok
CREATE CLUSTER foo SIZE '1'

statement ok
CREATE CLUSTER foo2 SIZE '32'

statement ok
CREATE CLUSTER foo3 SIZE '2-2'

# Test that introspection source indexes are created and dropped correctly

statement ok
DROP CLUSTER foo;

statement ok
DROP CLUSTER foo2;

statement ok
DROP CLUSTER foo3;

# There are 17 introspection sources
query I
SELECT COUNT(name) FROM mz_indexes WHERE cluster_id = 1;
----
17

query I
SELECT COUNT(name) FROM mz_indexes WHERE cluster_id <> 1;
----
0

statement ok
CREATE CLUSTER test size '1';

query I
SELECT COUNT(name) FROM mz_indexes;
----
34

statement ok
DROP CLUSTER test;

query T
SELECT COUNT(name) FROM mz_indexes;
----
17
