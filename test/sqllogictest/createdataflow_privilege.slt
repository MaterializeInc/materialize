# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

# Tests for the CREATEDATAFLOW privilege, which controls whether a user
# can execute queries that require dataflow rendering (slow path) on a cluster.

mode cockroach

reset-server

# Enable rbac checks.
simple conn=mz_system,user=mz_system
ALTER SYSTEM SET enable_rbac_checks TO true;
----
COMPLETE 0

# Create a test role
simple conn=mz_system,user=mz_system
CREATE ROLE restricted_user;
----
COMPLETE 0

# Create a cluster for testing with valid size
simple conn=mz_system,user=mz_system
CREATE CLUSTER test_cluster SIZE 'scale=1,workers=1';
----
COMPLETE 0

# Grant USAGE on cluster but NOT CREATEDATAFLOW
simple conn=mz_system,user=mz_system
GRANT USAGE ON CLUSTER test_cluster TO restricted_user;
----
COMPLETE 0

# Grant necessary database/schema access
simple conn=mz_system,user=mz_system
GRANT USAGE ON DATABASE materialize TO restricted_user;
----
COMPLETE 0

simple conn=mz_system,user=mz_system
GRANT USAGE ON SCHEMA materialize.public TO restricted_user;
----
COMPLETE 0

# Create a test table and index
simple conn=mz_system,user=mz_system
CREATE TABLE test_table (x INT, y INT);
----
COMPLETE 0

simple conn=mz_system,user=mz_system
CREATE INDEX test_idx ON test_table (x);
----
COMPLETE 0

# Grant SELECT on the table
simple conn=mz_system,user=mz_system
GRANT SELECT ON TABLE test_table TO restricted_user;
----
COMPLETE 0

# Test GRANT CREATEDATAFLOW syntax
simple conn=mz_system,user=mz_system
GRANT CREATEDATAFLOW ON CLUSTER test_cluster TO restricted_user;
----
COMPLETE 0

# Verify the privilege was granted by checking cluster privileges
query TT rowsort
SELECT name, unnest(privileges)::text FROM mz_clusters WHERE name = 'test_cluster';
----
test_cluster  mz_support=U/mz_system
test_cluster  mz_system=UCD/mz_system
test_cluster  restricted_user=UD/mz_system

# Test REVOKE CREATEDATAFLOW syntax
simple conn=mz_system,user=mz_system
REVOKE CREATEDATAFLOW ON CLUSTER test_cluster FROM restricted_user;
----
COMPLETE 0

# Verify the privilege was revoked (restricted_user still has U from GRANT USAGE)
query TT rowsort
SELECT name, unnest(privileges)::text FROM mz_clusters WHERE name = 'test_cluster';
----
test_cluster  mz_support=U/mz_system
test_cluster  mz_system=UCD/mz_system
test_cluster  restricted_user=U/mz_system

# Now test actual privilege enforcement

# Set up for testing as restricted_user
simple conn=restricted_user,user=restricted_user
SET CLUSTER = test_cluster;
----
COMPLETE 0

# Test constant query (fast path) - should succeed without CREATEDATAFLOW
simple conn=restricted_user,user=restricted_user
SELECT 1 + 1;
----
2
COMPLETE 1

# Test slow-path query without CREATEDATAFLOW - should fail
# (Query on column y not covered by index on x requires dataflow)
simple conn=restricted_user,user=restricted_user
SELECT * FROM test_table WHERE y = 1;
----
db error: ERROR: permission denied for CLUSTER "test_cluster"
DETAIL: The 'restricted_user' role needs CREATEDATAFLOW privileges on CLUSTER "test_cluster"

# Grant CREATEDATAFLOW and try again
simple conn=mz_system,user=mz_system
GRANT CREATEDATAFLOW ON CLUSTER test_cluster TO restricted_user;
----
COMPLETE 0

# Now the same query should succeed (empty result since table is empty)
simple conn=restricted_user,user=restricted_user
SELECT * FROM test_table WHERE y = 1;
----
COMPLETE 0

# Test REVOKE ALL on cluster removes CREATEDATAFLOW
simple conn=mz_system,user=mz_system
REVOKE ALL ON CLUSTER test_cluster FROM restricted_user;
----
COMPLETE 0

# Verify all privileges are revoked (restricted_user has no privileges left)
query TT rowsort
SELECT name, unnest(privileges)::text FROM mz_clusters WHERE name = 'test_cluster';
----
test_cluster  mz_support=U/mz_system
test_cluster  mz_system=UCD/mz_system

# Cleanup - revoke privileges from role before dropping
simple conn=mz_system,user=mz_system
REVOKE USAGE ON DATABASE materialize FROM restricted_user;
----
COMPLETE 0

simple conn=mz_system,user=mz_system
REVOKE USAGE ON SCHEMA materialize.public FROM restricted_user;
----
COMPLETE 0

simple conn=mz_system,user=mz_system
DROP CLUSTER test_cluster CASCADE;
----
COMPLETE 0

simple conn=mz_system,user=mz_system
DROP TABLE test_table CASCADE;
----
COMPLETE 0

simple conn=mz_system,user=mz_system
DROP ROLE restricted_user;
----
COMPLETE 0
