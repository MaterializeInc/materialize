# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

mode cockroach

reset-server

# This was split off from distinct_arrangements.slt, because this part changes more often, so we'd like to run at least
# this one in the non-Nightly CI.

# When updating this file, make sure that the number of arrangements doesn't
# increase unexpectedly. This is to prevent issues like this:
# https://github.com/MaterializeInc/database-issues/issues/6038

# Introspection subscribes add noise to the introspection sources, so disable them.
simple conn=mz_system,user=mz_system
ALTER SYSTEM SET enable_introspection_subscribes = false;
----
COMPLETE 0

# Check mz_catalog_server
statement ok
SET cluster TO mz_catalog_server

statement ok
SELECT mz_unsafe.mz_sleep(4)

query TI
SELECT mdod.name, count(*)
FROM mz_introspection.mz_arrangement_sharing mash
JOIN mz_introspection.mz_dataflow_operator_dataflows mdod ON mash.operator_id = mdod.id
WHERE mdod.dataflow_name NOT LIKE '%introspection-subscribe%'
GROUP BY mdod.name
ORDER BY mdod.name;
----
AccumulableErrorCheck  12
Arrange␠ReduceMinsMaxes  3
Arrange␠export␠iterative  2
Arrange␠export␠iterative␠err  2
Arrange␠recursive␠err  3
ArrangeAccumulable␠[val:␠empty]  12
ArrangeBy[[CallBinary(JsonbGetStringStringify(JsonbGetStringStringify),␠Column(1,␠"details"),␠Literal(Ok(Row{[String("id")]}),␠SqlColumnType␠{␠scalar_type:␠String,␠nullable:␠false␠}))]]  2
ArrangeBy[[CallBinary(JsonbGetStringStringify(JsonbGetStringStringify),␠Column(2,␠"details"),␠Literal(Ok(Row{[String("id")]}),␠SqlColumnType␠{␠scalar_type:␠String,␠nullable:␠false␠}))]]  1
ArrangeBy[[CallVariadic(Coalesce,␠[Column(2,␠"parent"),␠Column(3,␠"parent")])]]  2
ArrangeBy[[Column(0),␠Column(1),␠Column(2),␠Column(3),␠Column(4),␠Column(5),␠Column(6),␠Column(7),␠Column(8),␠Column(9),␠Column(10),␠Column(11),␠Column(12),␠Column(13),␠Column(14),␠Column(15),␠Column(16),␠Column(17),␠Column(18),␠Column(19),␠Column(20),␠Column(21),␠Column(22),␠Column(23),␠Column(24),␠Column(25),␠Column(26),␠Column(27),␠Column(28),␠Column(29)]]  2
ArrangeBy[[Column(0),␠Column(1),␠Column(2),␠Column(3),␠Column(4),␠Column(5),␠Column(6),␠Column(7),␠Column(8),␠Column(9),␠Column(10),␠Column(11),␠Column(12),␠Column(13),␠Column(14),␠Column(15),␠Column(16),␠Column(17),␠Column(18),␠Column(19),␠Column(20),␠Column(21)]]  2
ArrangeBy[[Column(0),␠Column(1)]]  1
ArrangeBy[[Column(0),␠Column(3)]]  1
ArrangeBy[[Column(0)]]  36
ArrangeBy[[Column(0,␠"attrelid"),␠Column(1,␠"attname"),␠Column(2,␠"atttypid"),␠Column(3,␠"attlen"),␠Column(4,␠"attnum"),␠Column(5,␠"atttypmod"),␠Column(7,␠"attnotnull"),␠Column(8,␠"atthasdef"),␠Column(9,␠"attidentity"),␠Column(10,␠"attgenerated"),␠Column(11,␠"attisdropped"),␠Column(12,␠"attcollation"),␠Column(13,␠"database_name"),␠Column(14,␠"pg_type_database_name")]]  1
ArrangeBy[[Column(0,␠"attrelid"),␠Column(1,␠"attname"),␠Column(2,␠"atttypid"),␠Column(3,␠"attlen"),␠Column(4,␠"attnum"),␠Column(5,␠"atttypmod"),␠Column(7,␠"attnotnull"),␠Column(8,␠"atthasdef"),␠Column(9,␠"attidentity"),␠Column(10,␠"attgenerated"),␠Column(11,␠"attisdropped"),␠Column(12,␠"attcollation"),␠Column(13,␠"database_name"),␠Column(14,␠"pg_type_database_name")]]-errors  1
ArrangeBy[[Column(0,␠"cluster")]]  1
ArrangeBy[[Column(0,␠"cluster")]]-errors  1
ArrangeBy[[Column(0,␠"cluster_id"),␠Column(2,␠"cluster_name")]]  1
ArrangeBy[[Column(0,␠"database_id")]]  1
ArrangeBy[[Column(0,␠"database_id")]]-errors  1
ArrangeBy[[Column(0,␠"id"),␠CallUnary(CastInt32ToNumeric(CastInt32ToNumeric(None)),␠Column(1,␠"object_sub_id"))]]  1
ArrangeBy[[Column(0,␠"id"),␠CallUnary(CastUint64ToNumeric(CastUint64ToNumeric(None)),␠Column(2,␠"position"))]]  1
ArrangeBy[[Column(0,␠"id"),␠CallUnary(Lower(Lower),␠Column(1,␠"object_type"))]]  1
ArrangeBy[[Column(0,␠"id"),␠CallUnary(Lower(Lower),␠Column(2,␠"type"))]]  1
ArrangeBy[[Column(0,␠"id"),␠Column(1,␠"replica_id")]]  3
ArrangeBy[[Column(0,␠"id"),␠Column(1,␠"replica_id")]]-errors  3
ArrangeBy[[Column(0,␠"id"),␠Column(2,␠"id")]]  1
ArrangeBy[[Column(0,␠"id"),␠Column(2,␠"position")]]  1
ArrangeBy[[Column(0,␠"id")]]  87
ArrangeBy[[Column(0,␠"id")]]-errors  17
ArrangeBy[[Column(0,␠"index_id")]]  1
ArrangeBy[[Column(0,␠"name")]]  3
ArrangeBy[[Column(0,␠"name")]]-errors  3
ArrangeBy[[Column(0,␠"object_id"),␠Column(1,␠"replica_id")]]  1
ArrangeBy[[Column(0,␠"object_id")]]  9
ArrangeBy[[Column(0,␠"object_id")]]-errors  5
ArrangeBy[[Column(0,␠"objoid"),␠Column(1,␠"classoid"),␠Column(2,␠"objsubid"),␠Column(3,␠"description"),␠Column(4,␠"oid_database_name"),␠Column(5,␠"class_database_name")]]  1
ArrangeBy[[Column(0,␠"objoid"),␠Column(1,␠"classoid"),␠Column(2,␠"objsubid"),␠Column(3,␠"description"),␠Column(4,␠"oid_database_name"),␠Column(5,␠"class_database_name")]]-errors  1
ArrangeBy[[Column(0,␠"oid"),␠Column(1,␠"adrelid"),␠Column(2,␠"adnum"),␠Column(3,␠"adbin"),␠Column(4,␠"adsrc")]]  1
ArrangeBy[[Column(0,␠"oid"),␠Column(1,␠"adrelid"),␠Column(2,␠"adnum"),␠Column(3,␠"adbin"),␠Column(4,␠"adsrc")]]-errors  1
ArrangeBy[[Column(0,␠"oid")]]  3
ArrangeBy[[Column(0,␠"oid")]]-errors  1
ArrangeBy[[Column(0,␠"replica_id"),␠Column(3,␠"bucket_start")]]  5
ArrangeBy[[Column(0,␠"replica_id"),␠Column(4,␠"bucket_start")]]  1
ArrangeBy[[Column(0,␠"replica_id")]]  12
ArrangeBy[[Column(0,␠"replica_id")]]-errors  5
ArrangeBy[[Column(0,␠"role_oid")]]  1
ArrangeBy[[Column(0,␠"schema_id")]]  6
ArrangeBy[[Column(0,␠"schema_id")]]-errors  6
ArrangeBy[[Column(0,␠"self")]]  1
ArrangeBy[[Column(0,␠"session_id")]]  1
ArrangeBy[[Column(0,␠"shard_id"),␠Column(2,␠"collection_timestamp")]]  1
ArrangeBy[[Column(0,␠"size")]]  1
ArrangeBy[[Column(0,␠"size")]]-errors  1
ArrangeBy[[Column(0,␠"source_id")]]  1
ArrangeBy[[Column(0,␠"sql_hash")]]  1
ArrangeBy[[Column(0,␠"sql_hash")]]-errors  1
ArrangeBy[[Column(0,␠"y")]]  1
ArrangeBy[[Column(1),␠Column(0)]]  1
ArrangeBy[[Column(1)]]  2
ArrangeBy[[Column(1,␠"cluster_id"),␠Column(2,␠"cluster_name")]]  1
ArrangeBy[[Column(1,␠"cluster_id")]]  3
ArrangeBy[[Column(1,␠"database_id")]]  1
ArrangeBy[[Column(1,␠"dependency_id")]]  1
ArrangeBy[[Column(1,␠"dependency_id")]]-errors  1
ArrangeBy[[Column(1,␠"element_id")]]  2
ArrangeBy[[Column(1,␠"id")]]  1
ArrangeBy[[Column(1,␠"id")]]-errors  1
ArrangeBy[[Column(1,␠"id_to_use")]]  1
ArrangeBy[[Column(1,␠"name")]]  1
ArrangeBy[[Column(1,␠"name")]]-errors  1
ArrangeBy[[Column(1,␠"nspname")]]  1
ArrangeBy[[Column(1,␠"nspname")]]-errors  1
ArrangeBy[[Column(1,␠"oid")]]  1
ArrangeBy[[Column(1,␠"on_id"),␠Column(3,␠"on_position")]]  1
ArrangeBy[[Column(1,␠"on_id")]]  1
ArrangeBy[[Column(1,␠"prepared_statement_id")]]  1
ArrangeBy[[Column(1,␠"referenced_object_id")]]  2
ArrangeBy[[Column(1,␠"relname")]]  1
ArrangeBy[[Column(1,␠"relname")]]-errors  1
ArrangeBy[[Column(1,␠"replica_id")]]  1
ArrangeBy[[Column(1,␠"rolname")]]  1
ArrangeBy[[Column(1,␠"rolname")]]-errors  1
ArrangeBy[[Column(1,␠"session_id")]]  1
ArrangeBy[[Column(1,␠"shard_id"),␠Column(2,␠"collection_timestamp")]]  1
ArrangeBy[[Column(1,␠"shard_id")]]  1
ArrangeBy[[Column(1,␠"sink_id")]]  1
ArrangeBy[[Column(1,␠"sink_id")]]-errors  1
ArrangeBy[[Column(1,␠"size")]]  1
ArrangeBy[[Column(1,␠"source_id")]]  2
ArrangeBy[[Column(1,␠"source_id")]]-errors  1
ArrangeBy[[Column(1,␠"y")]]  1
ArrangeBy[[Column(13,␠"database_id")]]  1
ArrangeBy[[Column(17,␠"cluster_id")]]  1
ArrangeBy[[Column(17,␠"cluster_id")]]-errors  1
ArrangeBy[[Column(2)]]  1
ArrangeBy[[Column(2,␠"cluster_id")]]  1
ArrangeBy[[Column(2,␠"database_id")]]  1
ArrangeBy[[Column(2,␠"database_id")]]-errors  1
ArrangeBy[[Column(2,␠"id")]]  1
ArrangeBy[[Column(2,␠"name")]]  1
ArrangeBy[[Column(2,␠"name")]]-errors  1
ArrangeBy[[Column(2,␠"on_id")]]  6
ArrangeBy[[Column(2,␠"owner_id")]]  1
ArrangeBy[[Column(2,␠"schema_id")]]  8
ArrangeBy[[Column(2,␠"schema_id")]]-errors  5
ArrangeBy[[Column(21,␠"sql_hash")]]  1
ArrangeBy[[Column(21,␠"sql_hash")]]-errors  1
ArrangeBy[[Column(3,␠"cluster_id")]]  2
ArrangeBy[[Column(3,␠"name")]]  1
ArrangeBy[[Column(3,␠"name")]]-errors  1
ArrangeBy[[Column(3,␠"on_id")]]  2
ArrangeBy[[Column(3,␠"schema_id")]]  1
ArrangeBy[[Column(3,␠"schema_id")]]-errors  1
ArrangeBy[[Column(4)]]  1
ArrangeBy[[Column(4,␠"cluster_id")]]  1
ArrangeBy[[Column(4,␠"schema_id")]]  2
ArrangeBy[[Column(4,␠"schema_id")]]-errors  2
ArrangeBy[[Column(5,␠"owner_id")]]  2
ArrangeBy[[Column(5,␠"type_oid")]]  1
ArrangeBy[[Column(6,␠"dropped_at")]]  1
ArrangeBy[[Column(6,␠"dropped_at")]]-errors  1
ArrangeBy[[Column(6,␠"schema_id")]]  1
ArrangeBy[[Column(6,␠"schema_id")]]-errors  1
ArrangeBy[[Column(7,␠"database_id")]]  1
ArrangeBy[[Column(9,␠"database_id")]]  1
ArrangeBy[[]]  11
Arranged␠DistinctBy  51
Arranged␠MinsMaxesHierarchical␠input  14
Arranged␠ReduceInaccumulable  3
Arranged␠TopK␠input  111
Distinct␠recursive␠err  3
DistinctBy  51
DistinctByErrorCheck  51
ReduceAccumulable  12
ReduceInaccumulable  3
ReduceInaccumulable␠Error␠Check  3
ReduceMinsMaxes  3
ReduceMinsMaxes␠Error␠Check  1
Reduced␠Fallibly␠MinsMaxesHierarchical  14
Reduced␠TopK␠input  111
Threshold␠local  10
