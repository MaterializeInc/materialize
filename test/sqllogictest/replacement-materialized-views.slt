# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

mode cockroach

# Setup

statement ok
CREATE TABLE t (a int, b int)

statement ok
INSERT INTO t VALUES (1, 2), (3, 4), (5, 6)

statement ok
CREATE CLUSTER other REPLICAS (r1 (SIZE 'scale=1,workers=1'), r2 (SIZE 'scale=2,workers=2'))


# Test: basic replacement workflow

statement ok
CREATE MATERIALIZED VIEW mv AS SELECT a, b FROM t

query II
SELECT * FROM mv
----
1 2
3 4
5 6

statement ok
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT a + b as a, b FROM t

query II
SELECT * FROM mv
----
1 2
3 4
5 6

query II
SELECT * FROM rp
----
3  2
7  4
11 6


# Ensure that querying the replacement view uses the definition, not the (replacement) materialized view.
query T multiline
EXPLAIN OPTIMIZED PLAN WITH (humanized expressions) AS VERBOSE TEXT FOR SELECT * FROM rp
----
Explained Query:
  Project (#2, #1{b})
    Map ((#0{a} + #1{b}))
      ReadStorage materialize.public.t

Source materialize.public.t

Target cluster: quickstart

EOF


query TTT colnames,rowsort
SHOW MATERIALIZED VIEWS
----
name cluster    comment
mv   quickstart (empty)
rp   quickstart (empty)

statement ok
ALTER MATERIALIZED VIEW mv APPLY REPLACEMENT rp

query TTT colnames,rowsort
SHOW MATERIALIZED VIEWS
----
name cluster    comment
mv   quickstart (empty)

query II
SELECT * FROM mv
----
3  2
7  4
11 6


# Test: aborted replacement workflow

statement ok
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT -a as a, b FROM t

query II
SELECT * FROM mv
----
3  2
7  4
11 6

query TTT colnames,rowsort
SHOW MATERIALIZED VIEWS
----
name cluster    comment
mv   quickstart (empty)
rp   quickstart (empty)

statement ok
DROP MATERIALIZED VIEW rp

query TTT colnames,rowsort
SHOW MATERIALIZED VIEWS
----
name cluster    comment
mv   quickstart (empty)

query II
SELECT * FROM mv
----
3  2
7  4
11 6


# Test: replacement can be created in another cluster

statement ok
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv IN CLUSTER other AS SELECT a, b FROM t;

query TTT colnames,rowsort
SHOW MATERIALIZED VIEWS
----
name cluster    comment
mv   quickstart (empty)
rp   other      (empty)

statement ok
ALTER MATERIALIZED VIEW mv APPLY REPLACEMENT rp

query TTT colnames,rowsort
SHOW MATERIALIZED VIEWS
----
name cluster comment
mv   other   (empty)


# Test: replacement can have the same query

statement ok
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv IN CLUSTER other AS SELECT a, b FROM t;

query TTT colnames,rowsort
SHOW MATERIALIZED VIEWS
----
name cluster comment
mv   other   (empty)
rp   other   (empty)

statement ok
ALTER MATERIALIZED VIEW mv APPLY REPLACEMENT rp

query TTT colnames,rowsort
SHOW MATERIALIZED VIEWS
----
name cluster comment
mv   other   (empty)


# Test: usage errors

statement error db error: ERROR: cannot replace table t with materialized view rp
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR t AS SELECT a, b FROM t

statement error db error: ERROR: t is a table not a materialized view
ALTER MATERIALIZED VIEW mv APPLY REPLACEMENT t

statement error db error: ERROR: cannot replace mv because it is also a dependency
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT * FROM mv

statement ok
CREATE MATERIALIZED VIEW mv2 AS SELECT * FROM mv

statement ok
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv2 AS SELECT a, b FROM t

statement error cannot replace materialized view mv with materialized view rp
ALTER MATERIALIZED VIEW mv APPLY REPLACEMENT rp

statement error cannot replace mv2 because it already has a replacement: rp
CREATE REPLACEMENT MATERIALIZED VIEW rp2 FOR mv2 AS SELECT a, b FROM t

statement ok
DROP MATERIALIZED VIEW mv2 CASCADE


# Test: replacement depends on target materialized view

statement ok
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT a, b FROM t

statement error db error: ERROR: cannot drop materialized view "mv": still depended upon by materialized view "rp"
DROP MATERIALIZED VIEW mv;


# Test: cannot create an object depending on a replacement

statement error db error: ERROR: replacement materialized view rp cannot be depended upon
CREATE VIEW v AS SELECT * FROM rp

statement error db error: ERROR: replacement materialized view rp cannot be depended upon
CREATE MATERIALIZED VIEW mv2 AS SELECT * FROM rp

statement error db error: ERROR: index cannot be created on materialize.public.rp because it is a replacement materialized view
CREATE DEFAULT INDEX ON rp


# Test: comments on replacements

statement ok
COMMENT ON MATERIALIZED VIEW rp IS 'comment:rp'

statement ok
COMMENT ON COLUMN rp.a IS 'comment:rp.a'

query TT rowsort
SELECT object_sub_id, comment
FROM mz_internal.mz_comments
WHERE object_type = 'materialized-view'
----
NULL  comment:rp
1     comment:rp.a

statement ok
ALTER MATERIALIZED VIEW mv APPLY REPLACEMENT rp

query TT rowsort
SELECT object_sub_id, comment
FROM mz_internal.mz_comments
WHERE object_type = 'materialized-view'
----


# Test: schema mismatch errors

# missing column in replacement
simple
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT a FROM t
----
db error: ERROR: replacement schema differs from target schema
DETAIL: missing column "b" at position 2

# extra column in replacement
simple
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT a, b, 1 as c FROM t
----
db error: ERROR: replacement schema differs from target schema
DETAIL: extra column "c" at position 3

# name mismatch
simple
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT a AS c, b FROM t
----
db error: ERROR: replacement schema differs from target schema
DETAIL: column at position 1: name mismatch (target: "a", replacement: "c")

# type mismatch
simple
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT a::text, b FROM t
----
db error: ERROR: replacement schema differs from target schema
DETAIL: column "a" at position 1: type mismatch (target: Int32, replacement: String)

# nullability mismatch
simple
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT a, b FROM t WHERE a IS NOT NULL
----
db error: ERROR: replacement schema differs from target schema
DETAIL: column "a" at position 1: nullability mismatch (target: NULL, replacement: NOT NULL)

# key mismatch
simple
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT DISTINCT a, b FROM t
----
db error: ERROR: replacement schema differs from target schema
DETAIL: keys differ (target: (none), replacement: {a, b})

# multiple mismatches
simple
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT DISTINCT a, b AS c, 1 AS d FROM t WHERE a IS NOT NULL
----
db error: ERROR: replacement schema differs from target schema
DETAIL: column "a" at position 1: nullability mismatch (target: NULL, replacement: NOT NULL)
column at position 2: name mismatch (target: "b", replacement: "c")
extra column "d" at position 3
keys differ (target: (none), replacement: {a, c})


statement ok
DROP MATERIALIZED VIEW mv CASCADE;
