# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

# Basic tests of the `CREATE SECRET`, `ALTER SECRET` and `DROP SECRET` DDL statements.

mode cockroach

query T
SHOW SECRETS
----

statement OK
CREATE SECRET secret AS decode('base64-encoded secret', 'base64');

statement OK
CREATE SECRET IF NOT EXISTS secret AS decode('base64-encoded secret', 'base64');

statement error catalog item 'secret' already exists
CREATE SECRET secret AS decode('base64-encoded secret', 'base64');

statement OK
CREATE SECRET key AS decode('base64-encoded secret', 'base64');

query TIT rowsort
SELECT * FROM mz_secrets
----
u1 3 secret
u4 3 key

query T rowsort
SHOW SECRETS
----
secret
key

query T
SHOW SECRETS LIKE 'k%'
----
key

statement OK
CREATE TABLE t1 (f1 INTEGER);

statement error catalog item 't1' already exists
CREATE SECRET t1 AS decode('base64-encoded secret', 'base64');

statement OK
DROP SECRET secret

statement error unknown catalog item 'secret'
DROP SECRET secret

statement OK
DROP SECRET IF EXISTS secret

statement OK
CREATE SECRET secret AS decode('base64-encoded secret', 'base64');

query T rowsort
SHOW SECRETS
----
key
secret

statement OK
ALTER SECRET key RENAME TO certificate

query T rowsort
SHOW SECRETS
----
certificate
secret

# Rename to an existing secret

statement OK
CREATE SECRET existing AS decode('existing secret', 'base64');

statement error existing is already taken by item in schema
ALTER SECRET certificate RENAME TO existing

statement error t1 is already taken by item in schema
ALTER SECRET certificate RENAME TO t1

statement OK
DROP SECRET existing

# Rename across schemas
statement error Expected end of statement, found dot
ALTER SECRET public.certificate RENAME TO public2.certificate2;

statement error ALTER SECRET not yet supported
alter secret certificate as decode('new base64-encoded secret', 'base64');

statement OK
create schema testschema

statement OK
CREATE SECRET testschema.key AS decode('base64-encoded secret', 'base64');

query T rowsort
SHOW SECRETS
----
certificate
secret

query T rowsort
SHOW SECRETS FROM testschema
----
key
