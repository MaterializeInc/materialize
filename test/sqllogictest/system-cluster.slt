# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

mode cockroach

# Start from a pristine server
reset-server

statement ok
SET CLUSTER TO mz_catalog_server

query T multiline
EXPLAIN SHOW DATABASES
----
Explained Query:
  Return
    Project (#0, #2)
      Map (coalesce(#1, ""))
        Union
          Map (null)
            Union
              Negate
                Project (#1)
                  Join on=(#0 = #2) type=differential
                    Get l0
                    ArrangeBy keys=[[#0]]
                      Distinct project=[#0]
                        Project (#0)
                          Get l1
              Project (#2)
                ReadIndex on=mz_databases mz_show_databases_ind=[*** full scan ***]
          Project (#1, #3)
            Filter (#2 = "database")
              Get l1
  With
    cte l1 =
      Project (#0, #1, #3, #5)
        Join on=(#0 = #2) type=differential
          Get l0
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_comments mz_comments_ind=[differential join]
    cte l0 =
      ArrangeBy keys=[[#0]]
        Project (#0, #2)
          ReadIndex on=mz_databases mz_show_databases_ind=[*** full scan ***]

Used Indexes:
  - mz_catalog.mz_show_databases_ind (*** full scan ***)
  - mz_internal.mz_comments_ind (differential join)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SHOW SCHEMAS
----
Explained Query:
  Return
    Project (#0, #2)
      Map (coalesce(#1, ""))
        Union
          Map (null)
            Union
              Negate
                Project (#1)
                  Join on=(#0 = #2) type=differential
                    ArrangeBy keys=[[#0]]
                      Project (#0, #3)
                        Get l1
                    ArrangeBy keys=[[#0]]
                      Distinct project=[#0]
                        Project (#0)
                          Get l0
              Project (#3)
                Get l1
          Project (#2, #4)
            Filter ((#1) IS NULL OR ((#1 = "u1") AND (#3 = "schema")))
              Get l0
  With
    cte l1 =
      Filter ((#2) IS NULL OR (#2 = "u1"))
        ReadIndex on=mz_schemas mz_show_schemas_ind=[*** full scan ***]
    cte l0 =
      Project (#0..=#2, #4, #6)
        Join on=(#0 = #3) type=differential
          ArrangeBy keys=[[#0]]
            Project (#0, #2, #3)
              ReadIndex on=mz_schemas mz_show_schemas_ind=[*** full scan ***]
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_comments mz_comments_ind=[differential join]

Used Indexes:
  - mz_catalog.mz_show_schemas_ind (*** full scan ***)
  - mz_internal.mz_comments_ind (differential join)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SHOW CONNECTIONS
----
Explained Query:
  Return
    Project (#0, #1, #3)
      Map (coalesce(#2, ""))
        Union
          Map (null)
            Union
              Negate
                Project (#1, #2)
                  Join on=(#0 = #3) type=differential
                    ArrangeBy keys=[[#0]]
                      Project (#0, #3, #4)
                        Get l1
                    ArrangeBy keys=[[#0]]
                      Distinct project=[#0]
                        Project (#0)
                          Get l0
              Project (#3, #4)
                Get l1
          Project (#2, #3, #5)
            Filter (#1 = "u3") AND (#4 = "connection")
              Get l0
  With
    cte l1 =
      ReadIndex on=mz_catalog.mz_connections mz_show_connections_ind=[lookup value=("u3")]
    cte l0 =
      Project (#0..=#3, #5, #7)
        Join on=(#0 = #4) type=differential
          ArrangeBy keys=[[#0]]
            Project (#0, #2..=#4)
              ReadIndex on=mz_connections mz_show_connections_ind=[*** full scan ***]
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_comments mz_comments_ind=[differential join]

Used Indexes:
  - mz_catalog.mz_show_connections_ind (*** full scan ***, lookup)
  - mz_internal.mz_comments_ind (differential join)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SHOW TABLES
----
Explained Query:
  Return
    Project (#0, #2)
      Map (coalesce(#1, ""))
        Union
          Map (null)
            Union
              Negate
                Project (#1)
                  Join on=(#0 = #2) type=differential
                    ArrangeBy keys=[[#0]]
                      Project (#0, #3)
                        Get l1
                    ArrangeBy keys=[[#0]]
                      Distinct project=[#0]
                        Project (#0)
                          Get l0
              Project (#3)
                Get l1
          Project (#2, #4)
            Filter (#1 = "u3") AND (#3 = "table")
              Get l0
  With
    cte l1 =
      ReadIndex on=mz_catalog.mz_tables mz_show_tables_ind=[lookup value=("u3")]
    cte l0 =
      Project (#0..=#2, #4, #6)
        Join on=(#0 = #3) type=differential
          ArrangeBy keys=[[#0]]
            Project (#0, #2, #3)
              ReadIndex on=mz_tables mz_show_tables_ind=[*** full scan ***]
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_comments mz_comments_ind=[differential join]

Used Indexes:
  - mz_catalog.mz_show_tables_ind (*** full scan ***, lookup)
  - mz_internal.mz_comments_ind (differential join)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SHOW SOURCES
----
Explained Query:
  Return
    Project (#0..=#2, #4)
      Map (coalesce(#3, ""))
        Union
          Map (null)
            Union
              Negate
                Project (#1..=#3)
                  Join on=(#0 = #4) type=differential
                    ArrangeBy keys=[[#0]]
                      Project (#0..=#3)
                        Get l1
                    ArrangeBy keys=[[#0]]
                      Distinct project=[#0]
                        Project (#0)
                          Get l0
              Project (#1..=#3)
                Get l1
          Project (#1..=#3, #6)
            Filter (#4 = "u3") AND (#5 = "source")
              Get l0
  With
    cte l1 =
      ReadIndex on=mz_internal.mz_show_sources mz_show_sources_ind=[lookup value=("u3")]
    cte l0 =
      Project (#0..=#4, #6, #8)
        Join on=(#0 = #5) type=differential
          ArrangeBy keys=[[#0]]
            Project (#0..=#4)
              ReadIndex on=mz_show_sources mz_show_sources_ind=[*** full scan ***]
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_comments mz_comments_ind=[differential join]

Used Indexes:
  - mz_internal.mz_show_sources_ind (*** full scan ***, lookup)
  - mz_internal.mz_comments_ind (differential join)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SHOW VIEWS
----
Explained Query:
  Return
    Project (#0, #2)
      Map (coalesce(#1, ""))
        Union
          Map (null)
            Union
              Negate
                Project (#1)
                  Join on=(#0 = #2) type=differential
                    ArrangeBy keys=[[#0]]
                      Project (#0, #3)
                        Get l1
                    ArrangeBy keys=[[#0]]
                      Distinct project=[#0]
                        Project (#0)
                          Get l0
              Project (#3)
                Get l1
          Project (#2, #4)
            Filter (#1 = "u3") AND (#3 = "view")
              Get l0
  With
    cte l1 =
      ReadIndex on=mz_catalog.mz_views mz_show_views_ind=[lookup value=("u3")]
    cte l0 =
      Project (#0..=#2, #4, #6)
        Join on=(#0 = #3) type=differential
          ArrangeBy keys=[[#0]]
            Project (#0, #2, #3)
              ReadIndex on=mz_views mz_show_views_ind=[*** full scan ***]
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_comments mz_comments_ind=[differential join]

Used Indexes:
  - mz_catalog.mz_show_views_ind (*** full scan ***, lookup)
  - mz_internal.mz_comments_ind (differential join)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SHOW MATERIALIZED VIEWS
----
Explained Query:
  Return
    Project (#0, #1, #3)
      Map (coalesce(#2, ""))
        Union
          Map (null)
            Union
              Negate
                Project (#1, #2)
                  Join on=(#0 = #3) type=differential
                    ArrangeBy keys=[[#0]]
                      Project (#0..=#2)
                        Get l1
                    ArrangeBy keys=[[#0]]
                      Distinct project=[#0]
                        Project (#0)
                          Get l0
              Project (#1, #2)
                Get l1
          Project (#1, #2, #5)
            Filter (#3 = "u3") AND (#4 = "materialized-view")
              Get l0
  With
    cte l1 =
      ReadIndex on=mz_internal.mz_show_materialized_views mz_show_materialized_views_ind=[lookup value=("u3")]
    cte l0 =
      Project (#0..=#3, #5, #7)
        Join on=(#0 = #4) type=differential
          ArrangeBy keys=[[#0]]
            Project (#0..=#3)
              ReadIndex on=mz_show_materialized_views mz_show_materialized_views_ind=[*** full scan ***]
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_comments mz_comments_ind=[differential join]

Used Indexes:
  - mz_internal.mz_show_materialized_views_ind (*** full scan ***, lookup)
  - mz_internal.mz_comments_ind (differential join)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SHOW MATERIALIZED VIEWS IN CLUSTER quickstart
----
Explained Query:
  Return
    Project (#0, #1, #3)
      Map (coalesce(#2, ""))
        Union
          Map (null)
            Union
              Negate
                Project (#1, #2)
                  Join on=(#0 = #3) type=differential
                    ArrangeBy keys=[[#0]]
                      Project (#0..=#2)
                        Get l1
                    ArrangeBy keys=[[#0]]
                      Distinct project=[#0]
                        Project (#0)
                          Get l0
              Project (#1, #2)
                Get l1
          Project (#1, #2, #6)
            Filter (#3 = "u3") AND (#4 = "u1") AND (#5 = "materialized-view")
              Get l0
  With
    cte l1 =
      Filter (#4 = "u1")
        ReadIndex on=mz_internal.mz_show_materialized_views mz_show_materialized_views_ind=[lookup value=("u3")]
    cte l0 =
      Project (#0..=#4, #6, #8)
        Join on=(#0 = #5) type=differential
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_show_materialized_views mz_show_materialized_views_ind=[*** full scan ***]
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_comments mz_comments_ind=[differential join]

Used Indexes:
  - mz_internal.mz_show_materialized_views_ind (*** full scan ***, lookup)
  - mz_internal.mz_comments_ind (differential join)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SHOW INDEXES
----
Explained Query:
  Return
    Project (#0..=#3, #5)
      Map (coalesce(#4, ""))
        Union
          Map (null)
            Union
              Negate
                Project (#1..=#4)
                  Join on=(#0 = #5) type=differential
                    ArrangeBy keys=[[#0]]
                      Project (#0..=#4)
                        Get l1
                    ArrangeBy keys=[[#0]]
                      Distinct project=[#0]
                        Project (#0)
                          Get l0
              Project (#1..=#4)
                Get l1
          Project (#1..=#4, #8)
            Filter (#6 = "u3") AND (#7 = "index") AND NOT(like["s%"](#5))
              Get l0
  With
    cte l1 =
      Filter NOT(like["s%"](#5))
        ReadIndex on=mz_internal.mz_show_indexes mz_show_indexes_ind=[lookup value=("u3")]
    cte l0 =
      Project (#0..=#6, #8, #10)
        Join on=(#0 = #7) type=differential
          ArrangeBy keys=[[#0]]
            Project (#0..=#6)
              ReadIndex on=mz_show_indexes mz_show_indexes_ind=[*** full scan ***]
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_comments mz_comments_ind=[differential join]

Used Indexes:
  - mz_internal.mz_show_indexes_ind (*** full scan ***, lookup)
  - mz_internal.mz_comments_ind (differential join)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SHOW INDEXES IN CLUSTER quickstart
----
Explained Query:
  Return
    Project (#0..=#3, #5)
      Map (coalesce(#4, ""))
        Union
          Map (null)
            Union
              Negate
                Project (#1..=#4)
                  Join on=(#0 = #5) type=differential
                    ArrangeBy keys=[[#0]]
                      Project (#0..=#4)
                        Get l1
                    ArrangeBy keys=[[#0]]
                      Distinct project=[#0]
                        Project (#0)
                          Get l0
              Project (#1..=#4)
                Get l1
          Project (#1..=#4, #7)
            Filter (#5 = "u1") AND (#6 = "index")
              Get l0
  With
    cte l1 =
      Filter (#7 = "u1")
        ReadIndex on=mz_show_indexes mz_show_indexes_ind=[*** full scan ***]
    cte l0 =
      Project (#0..=#5, #7, #9)
        Join on=(#0 = #6) type=differential
          ArrangeBy keys=[[#0]]
            Project (#0..=#4, #7)
              ReadIndex on=mz_show_indexes mz_show_indexes_ind=[*** full scan ***]
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_comments mz_comments_ind=[differential join]

Used Indexes:
  - mz_internal.mz_show_indexes_ind (*** full scan ***)
  - mz_internal.mz_comments_ind (differential join)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SHOW SINKS
----
Explained Query:
  Return
    Project (#0..=#2, #4)
      Map (coalesce(#3, ""))
        Union
          Map (null)
            Union
              Negate
                Project (#1..=#3)
                  Join on=(#0 = #4) type=differential
                    ArrangeBy keys=[[#0]]
                      Project (#0..=#3)
                        Get l1
                    ArrangeBy keys=[[#0]]
                      Distinct project=[#0]
                        Project (#0)
                          Get l0
              Project (#1..=#3)
                Get l1
          Project (#1..=#3, #6)
            Filter (#4 = "u3") AND (#5 = "sink")
              Get l0
  With
    cte l1 =
      ReadIndex on=mz_internal.mz_show_sinks mz_show_sinks_ind=[lookup value=("u3")]
    cte l0 =
      Project (#0..=#4, #6, #8)
        Join on=(#0 = #5) type=differential
          ArrangeBy keys=[[#0]]
            Project (#0..=#4)
              ReadIndex on=mz_show_sinks mz_show_sinks_ind=[*** full scan ***]
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_comments mz_comments_ind=[differential join]

Used Indexes:
  - mz_internal.mz_show_sinks_ind (*** full scan ***, lookup)
  - mz_internal.mz_comments_ind (differential join)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SHOW TYPES
----
Explained Query:
  Return
    Project (#0, #2)
      Map (coalesce(#1, ""))
        Union
          Map (null)
            Union
              Negate
                Project (#1)
                  Join on=(#0 = #2) type=differential
                    ArrangeBy keys=[[#0]]
                      Project (#0, #3)
                        Get l1
                    ArrangeBy keys=[[#0]]
                      Distinct project=[#0]
                        Project (#0)
                          Get l0
              Project (#3)
                Get l1
          Project (#2, #4)
            Filter (#1 = "u3") AND (#3 = "type")
              Get l0
  With
    cte l1 =
      ReadIndex on=mz_catalog.mz_types mz_show_types_ind=[lookup value=("u3")]
    cte l0 =
      Project (#0..=#2, #4, #6)
        Join on=(#0 = #3) type=differential
          ArrangeBy keys=[[#0]]
            Project (#0, #2, #3)
              ReadIndex on=mz_types mz_show_types_ind=[*** full scan ***]
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_comments mz_comments_ind=[differential join]

Used Indexes:
  - mz_catalog.mz_show_types_ind (*** full scan ***, lookup)
  - mz_internal.mz_comments_ind (differential join)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SHOW OBJECTS
----
Explained Query:
  Return
    Project (#0, #1, #3)
      Map (coalesce(#2, ""))
        Union
          Map (null)
            Union
              Negate
                Project (#1, #2)
                  Join on=(#0 = #3) type=differential
                    ArrangeBy keys=[[#0]]
                      Project (#0, #3, #4)
                        Get l1
                    ArrangeBy keys=[[#0]]
                      Distinct project=[#0]
                        Project (#0)
                          Get l0
              Project (#3, #4)
                Get l1
          Project (#2, #3, #5)
            Filter (#1 = "u3") AND ((#4 = "func") OR (#4 = "sink") OR (#4 = "type") OR (#4 = "view") OR (#4 = "index") OR (#4 = "table") OR (#4 = "secret") OR (#4 = "source") OR (#4 = "connection") OR (#4 = "materialized-view"))
              Get l0
  With
    cte l1 =
      ReadIndex on=mz_catalog.mz_objects mz_show_all_objects_ind=[lookup value=("u3")]
    cte l0 =
      Project (#0..=#3, #5, #7)
        Join on=(#0 = #4) type=differential
          ArrangeBy keys=[[#0]]
            Project (#0, #2..=#4)
              ReadIndex on=mz_objects mz_show_all_objects_ind=[*** full scan ***]
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_comments mz_comments_ind=[differential join]

Used Indexes:
  - mz_catalog.mz_show_all_objects_ind (*** full scan ***, lookup)
  - mz_internal.mz_comments_ind (differential join)

Target cluster: mz_catalog_server

EOF

statement ok
CREATE TABLE t (a INT)

query T multiline
EXPLAIN SHOW COLUMNS IN t
----
Explained Query:
  Return
    Project (#0..=#2, #4)
      Map (coalesce(#3, ""))
        Union
          Map (null)
            Union
              Negate
                Project (#0, #2, #3)
                  Join on=(#4 = bigint_to_numeric(#1)) type=differential
                    Get l2
                    ArrangeBy keys=[[#0]]
                      Distinct project=[integer_to_numeric(#0)]
                        Project (#3)
                          Get l3
              Project (#1, #3, #4)
                Get l1
          Project (#0..=#2, #4)
            Get l3
  With
    cte l3 =
      Project (#0, #2..=#5)
        Join on=(integer_to_numeric(#4) = bigint_to_numeric(#1)) type=differential
          Get l2
          ArrangeBy keys=[[integer_to_numeric(#0)]]
            Project (#2, #3)
              Filter (#2) IS NOT NULL
                ReadIndex on=mz_internal.mz_comments mz_comments_ind=[lookup values=<Get l0>]
    cte l2 =
      ArrangeBy keys=[[bigint_to_numeric(#1)]]
        Project (#1..=#4)
          Get l1
    cte l1 =
      ReadIndex on=mz_catalog.mz_columns mz_show_columns_ind=[lookup values=<Get l0>]
    cte l0 =
      ArrangeBy keys=[[#0]]
        Constant
          - ("u1")

Used Indexes:
  - mz_catalog.mz_show_columns_ind (lookup)
  - mz_internal.mz_comments_ind (lookup)

Target cluster: mz_catalog_server

EOF

# TODO[btv] - We should probably someday
# optimize `SELECT name FROM (SHOW CLUSTERS)`
# to do the same thing as `SELECT name FROM mz_clusters`;
# i.e., just read out of the index we have on the latter table.
# However, today we cannot do that. It's probably fine in practice
# as there won't be more than a few dozen clusters/replicas in any
# real world deployment, so spinning up a dataflow with joins
# etc. is only mildly bad.
#
# See discussion here: https://materializeinc.slack.com/archives/C02PPB50ZHS/p1691531471306959
#
# query T multiline
# EXPLAIN SELECT name FROM (SHOW CLUSTERS)
# ----
# Explained Query (fast path):
#   Project (#0)
#     ReadIndex mz_internal.mz_show_clusters_ind
#
# Used Indexes:
#   - mz_internal.mz_show_clusters_ind
#
# EOF

query T multiline
EXPLAIN SHOW CLUSTER REPLICAS
----
Explained Query:
  Return
    Project (#0..=#3, #5)
      Map (coalesce(#4, ""))
        Union
          Map (null)
            Union
              Negate
                Project (#0, #1, #3, #4)
                  Join on=(#2 = #5) type=differential
                    Get l0
                    ArrangeBy keys=[[#0]]
                      Distinct project=[#0]
                        Project (#2)
                          Get l1
              Project (#0, #1, #3, #4)
                ReadIndex on=mz_show_cluster_replicas mz_show_cluster_replicas_ind=[*** full scan ***]
          Project (#0, #1, #3, #4, #6)
            Filter (#5 = "cluster-replica")
              Get l1
  With
    cte l1 =
      Project (#0..=#4, #6, #8)
        Join on=(#2 = #5) type=differential
          Get l0
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_comments mz_comments_ind=[differential join]
    cte l0 =
      ArrangeBy keys=[[#2]]
        ReadIndex on=mz_show_cluster_replicas mz_show_cluster_replicas_ind=[*** full scan ***]

Used Indexes:
  - mz_internal.mz_show_cluster_replicas_ind (*** full scan ***)
  - mz_internal.mz_comments_ind (differential join)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SHOW CLUSTER REPLICAS WHERE cluster IN ('compute_qck', 'ingest_qck');
----
Explained Query:
  Return
    Project (#0..=#3, #5)
      Map (coalesce(#4, ""))
        Union
          Map (null)
            Union
              Negate
                Project (#0, #1, #3, #4)
                  Join on=(#2 = #5) type=differential
                    ArrangeBy keys=[[#2]]
                      Project (#0..=#4)
                        Get l1
                    ArrangeBy keys=[[#0]]
                      Distinct project=[#0]
                        Project (#2)
                          Get l0
              Project (#0, #1, #3, #4)
                Get l1
          Project (#0, #1, #3, #4, #6)
            Filter (#5 = "cluster-replica") AND ((#0 = "ingest_qck") OR (#0 = "compute_qck"))
              Get l0
  With
    cte l1 =
      ReadIndex on=mz_internal.mz_show_cluster_replicas mz_show_cluster_replicas_ind=[lookup values=[("ingest_qck"); ("compute_qck")]]
    cte l0 =
      Project (#0..=#4, #6, #8)
        Join on=(#2 = #5) type=differential
          ArrangeBy keys=[[#2]]
            ReadIndex on=mz_show_cluster_replicas mz_show_cluster_replicas_ind=[*** full scan ***]
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_comments mz_comments_ind=[differential join]

Used Indexes:
  - mz_internal.mz_show_cluster_replicas_ind (*** full scan ***, lookup)
  - mz_internal.mz_comments_ind (differential join)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SHOW SECRETS
----
Explained Query:
  Return
    Project (#0, #2)
      Map (coalesce(#1, ""))
        Union
          Map (null)
            Union
              Negate
                Project (#1)
                  Join on=(#0 = #2) type=differential
                    ArrangeBy keys=[[#0]]
                      Project (#0, #3)
                        Get l1
                    ArrangeBy keys=[[#0]]
                      Distinct project=[#0]
                        Project (#0)
                          Get l0
              Project (#3)
                Get l1
          Project (#2, #4)
            Filter (#1 = "u3") AND (#3 = "secret")
              Get l0
  With
    cte l1 =
      ReadIndex on=mz_catalog.mz_secrets mz_show_secrets_ind=[lookup value=("u3")]
    cte l0 =
      Project (#0..=#2, #4, #6)
        Join on=(#0 = #3) type=differential
          ArrangeBy keys=[[#0]]
            Project (#0, #2, #3)
              ReadIndex on=mz_secrets mz_show_secrets_ind=[*** full scan ***]
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_comments mz_comments_ind=[differential join]

Used Indexes:
  - mz_catalog.mz_show_secrets_ind (*** full scan ***, lookup)
  - mz_internal.mz_comments_ind (differential join)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SELECT id FROM mz_catalog.mz_indexes
----
Explained Query (fast path):
  Project (#0)
    ReadIndex on=mz_catalog.mz_indexes mz_indexes_ind=[*** full scan ***]

Used Indexes:
  - mz_catalog.mz_indexes_ind (*** full scan ***)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SELECT id FROM mz_catalog.mz_roles
----
Explained Query (fast path):
  Project (#0)
    ReadIndex on=mz_catalog.mz_roles mz_roles_ind=[*** full scan ***]

Used Indexes:
  - mz_catalog.mz_roles_ind (*** full scan ***)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SELECT id FROM mz_catalog.mz_sources
----
Explained Query (fast path):
  Project (#0)
    ReadIndex on=mz_catalog.mz_sources mz_sources_ind=[*** full scan ***]

Used Indexes:
  - mz_catalog.mz_sources_ind (*** full scan ***)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SELECT id FROM mz_catalog.mz_sinks
----
Explained Query (fast path):
  Project (#0)
    ReadIndex on=mz_catalog.mz_sinks mz_sinks_ind=[*** full scan ***]

Used Indexes:
  - mz_catalog.mz_sinks_ind (*** full scan ***)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SELECT id FROM mz_catalog.mz_materialized_views
----
Explained Query (fast path):
  Project (#0)
    ReadIndex on=mz_catalog.mz_materialized_views mz_materialized_views_ind=[*** full scan ***]

Used Indexes:
  - mz_catalog.mz_materialized_views_ind (*** full scan ***)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SELECT object_id FROM mz_internal.mz_object_dependencies
----
Explained Query (fast path):
  Project (#0)
    ReadIndex on=mz_internal.mz_object_dependencies mz_object_dependencies_ind=[*** full scan ***]

Used Indexes:
  - mz_internal.mz_object_dependencies_ind (*** full scan ***)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SELECT dependency_id FROM mz_internal.mz_compute_dependencies
----
Explained Query (fast path):
  Project (#0)
    ReadIndex on=mz_internal.mz_compute_dependencies mz_compute_dependencies_ind=[*** full scan ***]

Used Indexes:
  - mz_internal.mz_compute_dependencies_ind (*** full scan ***)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SELECT dropped_at FROM mz_internal.mz_cluster_replica_history
----
Explained Query (fast path):
  Project (#0)
    ReadIndex on=mz_internal.mz_cluster_replica_history mz_cluster_replica_history_ind=[*** full scan ***]

Used Indexes:
  - mz_internal.mz_cluster_replica_history_ind (*** full scan ***)

Target cluster: mz_catalog_server

EOF

# Following are used in the UI

query T multiline
EXPLAIN SELECT r.id,
  r.name as replica_name,
  r.cluster_id,
  r.size,
  c.name as cluster_name,
  u.memory_percent
FROM mz_cluster_replicas r
JOIN mz_clusters c ON c.id = r.cluster_id
JOIN mz_internal.mz_cluster_replica_utilization u ON u.replica_id = r.id
ORDER BY r.id;
----
Explained Query:
  Finish order_by=[#0 asc nulls_last] output=[#0..=#5]
    Project (#0..=#3, #5, #29)
      Map (((uint8_to_double(#27) / uint8_to_double(#21)) * 100))
        Join on=(#0 = #15 = #24 AND #2 = #4 AND #16 = #17) type=delta
          ArrangeBy keys=[[#0], [#2]]
            Project (#0..=#3)
              ReadIndex on=mz_cluster_replicas mz_cluster_replicas_ind=[*** full scan ***]
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_clusters mz_clusters_ind=[delta join lookup]
          ArrangeBy keys=[[#0], [#1]]
            Project (#0, #3)
              Filter (#3) IS NOT NULL
                ReadIndex on=mz_cluster_replicas mz_cluster_replicas_ind=[*** full scan ***]
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_cluster_replica_sizes mz_cluster_replica_sizes_ind=[delta join lookup]
          ArrangeBy keys=[[#0]]
            ReadIndex on=mz_cluster_replica_metrics mz_cluster_replica_metrics_ind=[delta join lookup]

Used Indexes:
  - mz_catalog.mz_clusters_ind (delta join lookup)
  - mz_catalog.mz_cluster_replicas_ind (*** full scan ***)
  - mz_catalog.mz_cluster_replica_sizes_ind (delta join lookup)
  - mz_internal.mz_cluster_replica_metrics_ind (delta join lookup)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SELECT s.id, s.oid, s.name, s.type, s.size, st.status, st.error
FROM mz_sources s
LEFT OUTER JOIN mz_internal.mz_source_statuses st
ON st.id = s.id
WHERE s.id LIKE 'u%';
----
Explained Query:
  Return
    Union
      Map (null, null)
        Union
          Negate
            Project (#0, #1, #3, #4, #6)
              Filter like["u%"](#0)
                Join on=(#0 = #15) type=differential
                  Get l0
                  ArrangeBy keys=[[#0]]
                    Distinct project=[#0]
                      Project (#0)
                        Get l1
          Project (#0, #1, #3, #4, #6)
            Filter like["u%"](#0)
              ReadIndex on=mz_sources mz_sources_ind=[*** full scan ***]
      Get l1
  With
    cte l1 =
      Project (#0, #1, #3, #4, #6, #19, #20)
        Filter like["u%"](#0)
          Join on=(#0 = #15) type=differential
            Get l0
            ArrangeBy keys=[[#0]]
              ReadIndex on=mz_source_statuses mz_source_statuses_ind=[differential join]
    cte l0 =
      ArrangeBy keys=[[#0]]
        ReadIndex on=mz_sources mz_sources_ind=[differential join]

Used Indexes:
  - mz_catalog.mz_sources_ind (*** full scan ***, differential join)
  - mz_internal.mz_source_statuses_ind (differential join)

Target cluster: mz_catalog_server

EOF

query T multiline
EXPLAIN SELECT MAX(extract(epoch from h.occurred_at) * 1000) as last_occurred, h.error, COUNT(h.occurred_at)
FROM mz_internal.mz_source_status_history h
WHERE source_id = 'u6'
AND error IS NOT NULL
AND h.occurred_at BETWEEN 0 AND 100
GROUP BY h.error
ORDER BY last_occurred DESC
LIMIT 10;
----
Explained Query:
  Finish order_by=[#0 desc nulls_first] limit=10 output=[#0..=#2]
    Project (#1, #0, #2)
      Reduce group_by=[#1] aggregates=[max((extract_epoch_tstz(#0) * 1000)), count(*)]
        Project (#0, #3)
          Filter (#6 <= 100) AND (#6 >= 0) AND (#3) IS NOT NULL
            Map (timestamp_tz_to_mz_timestamp(#0))
              ReadIndex on=mz_internal.mz_source_status_history mz_source_status_history_ind=[lookup value=("u6")]

Used Indexes:
  - mz_internal.mz_source_status_history_ind (lookup)

Target cluster: mz_catalog_server

EOF

# Querying user objects should not be allowed from the catalog server cluster.

statement ok
CREATE CLUSTER foo REPLICAS (r1 (SIZE '1'));

statement ok
SET CLUSTER TO foo;

statement ok
CREATE TABLE bar ( key text, val bigint );

statement ok
SET CLUSTER TO mz_catalog_server;

statement error db error: ERROR: querying the following items "materialize\.public\.bar" is not allowed from the "mz_catalog_server" cluster
SELECT key FROM bar;

# But inspecting those objects, e.g. checking what indexes exist, should be allowed.
statement ok
SHOW INDEXES on bar;

statement ok
SET CLUSTER TO mz_catalog_server;

statement ok
DROP CLUSTER foo CASCADE;

# Creating views with the mz_catalog_server cluster active should be allowed though.
statement ok
CREATE VIEW keys AS ( SELECT key FROM bar );

# But creating objects that install resources, should not be allowed.

simple conn=mz_system,user=mz_system
ALTER SYSTEM SET enable_rbac_checks TO false;
----
COMPLETE 0

statement error permission denied for CLUSTER "mz_catalog_server"
CREATE MATERIALIZED VIEW live_keys AS ( SELECT key FROM bar );

statement error must be owner of CLUSTER mz_catalog_server
ALTER CLUSTER mz_catalog_server SET (REPLICATION FACTOR 2);

statement error permission denied for CLUSTER "mz_catalog_server"
CREATE INDEX i_keys ON bar (key);

statement error must be owner of CLUSTER mz_system
ALTER CLUSTER mz_system SET (MANAGED = false)

simple conn=mz_system,user=mz_system
ALTER CLUSTER mz_system SET (REPLICATION FACTOR 0)
----
COMPLETE 0

statement error must be owner of CLUSTER mz_system
ALTER CLUSTER mz_system SET (REPLICATION FACTOR 1)

simple conn=mz_system,user=mz_system
ALTER CLUSTER mz_system SET (REPLICATION FACTOR 1)
----
COMPLETE 0

# Replicas in system clusters should system IDs.

simple conn=mz_system,user=mz_system
ALTER CLUSTER mz_system SET (SIZE = '2')
----
COMPLETE 0

query I
SELECT COUNT(*) FROM mz_cluster_replicas WHERE cluster_id = (SELECT id FROM mz_clusters WHERE name = 'mz_system') AND id LIKE 's%';
----
1

query I
SELECT COUNT(*) FROM mz_cluster_replicas WHERE cluster_id = (SELECT id FROM mz_clusters WHERE name = 'mz_system') AND id LIKE 'u%';
----
0

reset-server
