# Copyright Materialize, Inc. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

statement ok
CREATE TABLE t (a int)

statement ok
INSERT INTO t (a) VALUES (1)

# Must specify read tables.
statement ok
BEGIN

query error t not included in transaction WITH READS FROM
SELECT * FROM t
----
1

statement ok
COMMIT

# Specify read table.
statement ok
BEGIN WITH READS FROM t

query I rowsort
SELECT * FROM t
----
1

statement ok
COMMIT

# Can also use SET.
statement ok
BEGIN

statement ok
SET TRANSACTION WITH READS FROM t

query I rowsort
SELECT * FROM t
----
1

statement ok
COMMIT

# Can't SET after query.
statement ok
BEGIN WITH READS FROM t

query I rowsort
SELECT * FROM t
----
1

statement error timestamp already set
SET TRANSACTION WITH READS FROM t

statement ok
COMMIT

# No mutations.
statement ok
BEGIN

statement error within transactions only Peeks supported
INSERT INTO t VALUES (1)

statement ok
COMMIT

# Enforce that at least 1 read source exists.
statement ok
BEGIN

query error transaction must have at least 1 read source
SELECT 1

statement ok
COMMIT
