# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

# Tests of optimizing across views

## Tests that not-materialized dependent views get inlined when planning to
## materialize a view

statement ok
CREATE TABLE foo (a int, b int)

statement ok
CREATE VIEW foo2 as select b from foo where a = 5;

statement ok
CREATE VIEW foo3 as select b from foo2 where b = 6;

query T multiline
EXPLAIN WITH(arity, join_impls) SELECT * from foo3
----
Explained Query:
  Project (#1) // { arity: 1 }
    Filter (#0 = 5) AND (#1 = 6) // { arity: 2 }
      Get materialize.public.foo // { arity: 2 }

Source materialize.public.foo
  filter=((#0 = 5) AND (#1 = 6))

EOF

query T multiline
EXPLAIN WITH(arity, join_impls) VIEW foo3
----
materialize.public.foo3:
  Project (#1) // { arity: 1 }
    Filter (#0 = 5) AND (#1 = 6) // { arity: 2 }
      Get materialize.public.foo // { arity: 2 }

Source materialize.public.foo
  filter=((#0 = 5) AND (#1 = 6))

EOF

statement ok
CREATE DEFAULT INDEX ON foo2

query T multiline
EXPLAIN WITH(arity, join_impls) VIEW foo3
----
materialize.public.foo3:
  Project (#0) // { arity: 1 }
    ReadExistingIndex materialize.public.foo2 lookup_value=(6)

Used Indexes:
  - materialize.public.foo2_primary_idx

EOF

query T multiline
EXPLAIN WITH(arity, join_impls) SELECT * from foo3
----
Explained Query (fast path):
  Project (#0)
    ReadExistingIndex materialize.public.foo2_primary_idx lookup_value=(6)

Used Indexes:
  - materialize.public.foo2_primary_idx

EOF
